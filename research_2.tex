\documentclass[12pt]{report}
\usepackage{geometry}	
\usepackage{cite}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{multicol}
\usepackage{titlesec}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{textcomp}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{comment}
\usepackage{etoolbox}
\usepackage{caption}
\usepackage{anyfontsize}
\usepackage{caption}
\usepackage{color}
\usepackage{url}
\usepackage{multirow}
\usepackage{array}
\usepackage{tabu}
\usepackage{hyperref}
\usepackage{color}
\usepackage{epigraph}
\usepackage{makebox}

\renewcommand{\arraystretch}{2}
\renewcommand{\bibname}{References}
\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    %linkcolor=[RGB]{0,204,0},
    linkcolor=black,
    urlcolor=black
}
\captionsetup[figure]{labelfont=bf, font=footnotesize}

\setlength{\parskip}{1em}
% \setcounter{tocdepth}{4} 
% \setcounter{secnumdepth}{4}

%this several lines is for: no number before suction. (This is a bug)
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother


\geometry{
	a4paper,
	% total={210mm,297mm},
 	left=35mm,
 	top=25mm,
 	right=35mm,
}

\title{\textbf{Gamma-ray Analysis of Millisecond Pulsars PSR J0218+4232, PSR B1821-24 and PSR B1937+21}\\ \vspace{1cm}
			{\large Department of Physics, The University of Hong Kong, Pokfulam Road, Hong Kong}\\ \vspace{1cm}
			% {\includegraphics[scale=0.2]{{/Users/grewwc/Desktop/Thesis/hku.png}}}\\ \vspace{3cm}
}
\date{}
\author{Wang Wenchao  \\3030053350}
\setlength{\columnsep}{1cm}

\titleformat
{\chapter} % command
[display] % shape
{\bfseries\Large} % format
{\textit{Chapter \thechapter}} % label
{0.5ex} % sep
{
    \rule{\textwidth}{1pt}
    \vspace{1ex}
    \centering
} % before-code

\titleformat{\section}[hang]
{\large\bfseries}
{\thesection}
{0.5em}
{}

\titleformat{\subsection}[hang]
{\fontsize{12}{15}\bfseries\sffamily}
{\thesubsection}
{1em}
{}

\titleformat{\subsubsection}[hang]
{\fontsize{11}{15}\bfseries\sffamily}
{\thesubsection}
{0.5em}
{}

\titleformat{\subsubsubsection}[hang]
{\fontsize{9}{15}\bfseries\sffamily}
{\thesubsection}
{0.5em}
{}

\newcommand{\mycaption}[1]{\caption{\textit{\footnotesize #1}}}
%Below is the main content.

%insert a single figure.
%parameters: 
%%  1. path
%%  2. scale
%%  3. caption
\newcommand{\singleFig}[3]{
 \begin{figure}[!ht]
  \centering
  \includegraphics[scale=#2]{/Users/grewwc/Desktop/Thesis/#1}
  \mycaption{#3}
 \label{fig: #1}
 \end{figure}
 \vspace{0.5cm} 
}

\newcommand{\gj}[0]{
  Goldreich-Julian charge density
}

\newcommand{\question}[1]{
  $<$\textbf{question}$>$#1$<$\textbf{/question}$>$
}

\newcommand{\change}[1]{
  $<$\colorbox{red}{\textbf{change}}$>$#1$<$\colorbox{red}{\textbf{/change}}$>$
}

\newcommand{\add}[1]{
  $<$\colorbox{red}{\textbf{add}}$>$#1$<$\colorbox{red}{\textbf{/add}}$>$
}

\newcommand{\mayAdd}[1]{
  $<$\colorbox{red}{\textbf{mayAdd}}$>$#1$<$\colorbox{red}{\textbf{/mayAdd}}$>$
}


\newcommand{\mayChange}[1]{
  $<$\colorbox{red}{\textbf{mayChange}}$>$#1$<$\colorbox{red}{\textbf{/mayChange}}$>$
}

\newcommand{\myComment}[1]{
  %#1 
  \newline
}

\newcommand{\Notice}[1]{
  $<$\textbf{Notice}$>$#1$<$\textbf{/Notice}$>$
}

\newcommand{\blackhref}[2]{
  \href{#1}{\color{black}{\textit{\small #2}}}
}

\begin{document}
\maketitle
\tableofcontents{}
   %\vspace{1cm}
    %chapter 'Abstract'.
\begin{abstract}
    \normalsize
    In the thesis, we mainly introduce our study on the high energy spectra of three millisecond pulsars which are  
    PSR J0218+4232, PSR B1821-24 and PSR B1937+21. 
    The Fermi LAT Pass 8 data was published in 2015 and has lots of advantages over the old Pass 7 data, 
    such as increased effective area and wider energy range. Since the recent gamma-ray spectra analysis of 
    the three MSPs are relatively old (in about 2014), we redo the gamma-ray spectra analysis of the MSPs with 
    4-year more Fermi LAT observation data and newly published Pass 8 data. 
    As we expected, we obtain better fit results for gamma-ray spectra of 
    the three MSPs with smaller errors and larger test statistic values. Then we briefly introduce 
    a pulsar emission model called two-layer model \cite{0004-637X-787-2-167} and do numerical simulation 
    to test the two-layer model using the new observation data.
    By minimizing the differences between the predictions of the two-layer model and the real 
    data, we fit the independent parameters of the two-layer model, which can help us understand the 
    emission mechanism of pulsars. We find that though the two-layer model is simple, it can generate 
    broad-band spectra of pulsars which are very close to the observation data from Fermi LAT in most energy 
    bands.

\end{abstract}
			
%chapter 'Introduction'.
\chapter{Introduction}   	   
    \section{Neutron Stars and Pulsars}
        Neutron stars are produced by a supernova explosion of massive stars which have about 4 to 8 
        solar mass. After 
        the supernova explosion, the star leaves a central region. And the central region collapses because 
        of the effect of 
        gravity until protons and electrons combine to form neutrons ($e^{-}+p\rightarrow n+\nu_{e}$)
        ---the reason why they are called 
        ``neutron stars''.  
        Because neutrons have no electromagnetic force on each other, they can be squeezed very tightly. 
        Therefore, a neutron  
        star has tremendous high density (about $5\times 10^{17} kg/m^3$) and its diameter and mass is about
        20km and 
        1.4 solar mass respectively. What
        prevents a neutron star to continue to contract is the degeneracy pressure of neutrons. 
        
        Pulsars are fast-spinning neutron stars. Their rotational periods can be from a few 
        milliseconds
        to several seconds. For example, the rotational period of PSR B1937+21 is about 1.56$ms$ while 
        PSR B1919+21 is approximately 1.34$s$. As we know, a star can be ripped by centrifugal force if the
        star rotates too fast. We can estimate lower limit of density of a star with the equation: 
        $\rho=\frac{3\pi}{P^2G}$, where $P$ is the rotational period of a pulsar. Just for simplicity, we
        let $P$ be 1$s$. Then we get $\rho\approx 1.4\times 10^{11}kg/m^3$. With the knowledge  that the 
        density of a white dwarf is about $1\times 10^9kg/m^3$ which is smaller than the lower density limit,
        the observed fast-spinning stars belong to the kind of stars which are much denser 
        than white dwarf. As a result, neutron stars are ideal candidates for pulsars. \\
        \indent
        More than 2000 pulsars have been found so far. Most of them are in the disk of our Galaxy while we also can 
        find a small portion of them in high latitude, which can be seen clearly in the Fig 
        \ref{fig: spatial_distribution}. This may 
        because they cannot escape the gravitational potential if their kinetic energy is not large enough. Besides,
        even though they have large enough velocities to escape from their birth region, there are some 
        probabilities that they become nearly non-detectable before reaching high latitude. 

        \begin{figure}[h]
          \centering
          \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/pulsar_distribution.png}
          \caption{\textit{\footnotesize Spatial distribution of some pulsars in galactic coordinate system.}}
          \label{fig: spatial_distribution}
        \end{figure}
        


        % \add{can add these content later.}
        % \iffalse 
        % \indent Although the primary focuses of this thesis are observational characteristics such as 
        % spectra and light-curves, it is helpful to talk a little about internal structure of pulsars.
        % \fi 

        % \iffalse
        % \indent Many stars are in binary systems so neutron stars can also be isolated or in binary systems. 
        % Some of them even have planets. That a pulsar is in binary system provides us a convenient way to 
        % measure its mass. 
        % \indent 
        % \fi

    \section{Emission Mechanism of Pulsars}
            Although emission mechanism of pulsars has not been fully understood yet, some models are developed 
            trying to explain observational facts. The following is one toy model that can explain some basic 
            features of pulsars. In this structure, the magnetic dipole model is introduced first, followed by 
            synchrotron radiation and inverse Compton radiation. 
       
        \subsection{Magnetic Dipole Model}
            Assume a pulsar has a magnetic dipole moment $\vec{m}$, the angel between rotation axis and 
            direction of 
            $\vec{m}$ is $\alpha$, its angular velocity is $\Omega$, radius is R and moment of inertia is $I$. 
            Also by 
            assuming that energy of electromagnetic radiation are all from rotational energy, its spin-down 
            rate can be written 
            as: 
            $$
                \dot{\Omega}=-\frac{B_p^2 R^6 \Omega^3 \sin{\alpha}^3}{6c^3I}
            $$
            where $B_p$ is magnetic field strength in the pole of the pulsar. Its surface magnetic field can 
            also be estimated
            by:
            $$
                B_s=\sqrt{\frac{3c^3I}{2\pi^2R^6}P\dot{P}}=3.2\times 10^{19}\sqrt{P\dot{P}}
            $$
            where $B_s$ is the strength of surface magnetic field. \\
            \indent In general, a pulsar's spin down rate can be expressed as: $\dot{\Omega}=-K\Omega^{n}$, 
            where K is a 
            constant and n is called braking index. In magnetic dipole model n is 3 \cite{Tong2015}. Then 
            characteristic age of the pulsar can be defined as: $P/2\dot{P}$ in magnetic dipole model. 
            For example, the Crab 
            pulsar's rotation period is about $0.033s$ and period derivative is $4.22\times 10^{-13}s/s$. 
            The characteristic 
            age is about 1200 years. The pulsar is remnant of a supernova which is observed by ancient 
            astronomers in 1054 
            AD, so the record shows that characteristic age can give us order of magnetic estimate of a 
            pulsar's real age. \\
            \indent 
            Although braking index is 3 in magnetic dipole model, most of pulsars' braking index is less than 3 as 
            shown in figure \ref{fig:braking_index}. The reason is that if a pulsar's spin down is completely because
            of pulsar wind, the braking index is 1. Thus, the real braking index should be a combination of 1 and 3,
            which is usually less than 3 \cite{PhysRevD.91.063007}.

            
            \begin{figure}[!ht]
              \centering
              \includegraphics[scale=0.6]{/Users/grewwc/Desktop/Thesis/table.png}
              \mycaption{Braking index of some pulsars.}
              \label{fig:braking_index}
            \end{figure}
    
        \subsection{Synchrotron Radiation}
              Synchrotron radiation is a special case of cyclotron radiation when particles' speed is comparable to the 
              speed of light. Because of the relativistic beaming effect, we will observe a very short radiation pulse 
              when speed of particles is large. 
              We only aim to analyze the spectrum properties of MSPs, so we focus on the 
              spectrum property of synchrotron radiation. The power spectrum of a single electron  
              can be described by the function \ref{func: syncrothron spectrum}
            \begin{equation}
              \label{func: syncrothron spectrum}
              P\left(\nu\right) = \frac{\sqrt{3} e^3 B \sin{\alpha}}{m c^2} 
                \left(\frac{\nu}{\nu_c}\right) \int_{\nu / \nu_c}^{\infty} K_{5/3}\left(\eta \right)d\eta 
            \end{equation}
            where $\nu_c$ is the critical frequency and $K_{5/3}$ is modified Bessel function. The critical frequency 
            can be expressed by the function \ref{func: critical_frequency}
            \begin{equation}
              \label{func: critical_frequency}
              \nu_c = \frac{3}{2} \gamma^2 \nu_{cyc} \sin{\alpha}
            \end{equation} 
            where $\alpha$ is the pitch angle and the $\nu_{cyc}$ is the frequency of corresponding cyclotron radiation. 
  
            These function does not give us very much information because of the integration of the modified Bessel 
            function. We let $x = \nu / \nu_c$ and fix the environment variables such as magnetic field ($B$), 
            the function \ref{func: syncrothron spectrum} becomes: 
            \begin{equation}
              \label{func: to_x}
              P\left(\nu\right) = C \times x \int_{x}^{\infty} K_{5/3}\left(\eta \right)d\eta 
            \end{equation}
            where $C$ is a constant dependent on $B$. Thus, in order to analyze the power spectrum of synchrotron radiation,
            we only concentrate on the later part, which is
            \begin{equation}
              \label{func: fx}
              F\left(x\right) = x \int_{x}^{\infty} K_{5/3}\left(\eta \right)d\eta 
            \end{equation}
            
            \begin{figure}[!ht] 
            \begin{minipage}{\textwidth}
              \begin{center} 
                \includegraphics[scale=0.6]{/Users/grewwc/Desktop/Thesis/sync_spectrum_loglog.png}
              \end{center}
              \end{minipage}
              \\
            \begin{minipage}{\textwidth}
              \begin{center}
              \includegraphics[scale=0.61]{/Users/grewwc/Desktop/Thesis/sync_power_loglog.png}
              \end{center}
            \end{minipage}
            \centering
            \begin{minipage}{0.8\textwidth}
              \mycaption{According to the function \ref{func: fx}, top: $F\left(x\right)$; bottom: $x F\left(x\right)$.
                \change{should change the style of the Fig..}}
              \label{fig: sync_spectrum_loglog}
            \end{minipage}
            \end{figure}
            
            The top figure \ref{func: fx} describes the general shape of power spectrum of synchrotron radiation
            When the frequency is larger than
            the critical frequency $\nu_c$, the power goes down dramatically. However, the top figure does not show 
            the information that at what frequency the electron emit the strongest power, which is in the bottom figure.
            The bottom figure shows that the energy most energy emitted around critical frequency. 
  
            In reality, synchrotron radiations are not generated by a single particle. We describe the number density 
            distribution of electrons with respect to energy by a single power-law model as the function 
            \ref{func: sync_number_density} shown.
            \begin{equation}
              \label{func: sync_number_density}
              N\left(E\right) \approx C E^{-\delta}
            \end{equation}
          
            For simplicity, we set the ambient magnetic field $B$ to be a constant and make an approximation that all 
            radiations are at a single frequency:
            \begin{equation}
              \label{func: sync_approximation}
              \nu \approx \gamma^2 \nu_{cyc}
            \end{equation}
            where the meaning of $\nu_{cyc}$ is the same as function \ref{func: critical_frequency}. Our objective is to
            know the relationship between total power of all electrons and their radiation frequency. We describe the 
            relationship as the function \ref{func: sync_power_single_frequency}
            
            \begin{eqnarray}
              \label{func: sync_power_single_frequency}
              -P\left(E\right)N\left(E\right)dE &=& Q_{\nu} d\nu\\
              P\left(E\right) &=& \frac{4}{3} \sigma_{T} \beta^2 \gamma^2 c U_B
            \end{eqnarray} 
            where $\sigma_{T}$ is electron Thompson scattering section, $U_B$ is energy density of the environment 
            magnetic field,  $Q_{nu}$ is the emission coefficient of synchrotron radiation 
            and $E=\gamma m_e c^2$. With function \ref{func: sync_approximation}, we have
            \begin{equation}
              \label{func: sync_combine}
              P = \frac{dE}{d\nu} = \frac{m_e c^2}{2\sqrt{\nu \nu_{cyc}}}
            \end{equation}
            Combine the function \ref{func: sync_combine} and \ref{func: sync_power_single_frequency} we get:
            \begin{equation}
              Q_{\nu} = \frac{4}{3} \sigma_{T} \beta^2 \gamma^2 c U_B \frac{m_e c^2}{2\sqrt{\nu \nu_{cyc}}} N\left(E\right)
            \end{equation}
            By ignoring constants in the function \ref{func: sync_power_single_frequency} we have 
            \begin{equation}
              \label{func: sync_final}
              Q_{\nu} \propto \nu^{(1-\delta)/2}
            \end{equation}
            The function \ref{func: sync_final} shows that if the number density electrons is a power-law distribution, 
            the spectrum of synchrotron radiation is also a power-lay model.  
            %end of synchrotron.
  
          % \subsection{Curvature Radiation}
          %   When particles move along the curved magnetic field lines, they will generate curvature radiation. This is 
          %   exactly the case in a pulsar's magnetosphere. The magnetic field is so strong that relativistic 
          %   charged particles (electrons and positrons) are forced to move along the magnetic field line and hence 
          %   emit strong curvature radiation. 
            
          %   \add{continue from here}
          %end of "Curvature Radiation"
          \subsection{Inverse-Compton radiation}
          If a energetic relativistic photon collides with a charged particle from an proper incident angle,
          the photon's energy decreases and direction changes. This is a process of Compton Scattering. 
          Inverse-Compton radiation is the opposite process by which a low energy photon gained energy 
          from an ultra-relativistic electron. 

          \singleFig{inverse_compton}{0.45}{Inverse Compton Diagram \Notice{this figure is from internet}}
          
          As the Fig.\ref{fig: inverse_compton} showing, in the laboratory frame ($S$), the incident angle and 
          energy of a photon is $\theta$ and $h \nu$ respectively. The speed of the electron is $v$. In the 
          electron rest frame ($S^{\prime}$), we change the denotation to $\theta^{\prime}$, $h \nu^{\prime}$ and.
          Also, let the position of the electron be the origin point of $S^{\prime}$.
          We can study the whole process in the $S^{\prime}$ frame, the transfer the result 
          to the $S$ frame by Lorentz transformation. 

          In the $S^{\prime}$ frame, the electron is at rest so its energy is $m_e c^2$. 
          For Inverse Compton scattering, the energy of an incident photon (less than several $keV$) 
          is much less than the rest energy of an electron (about $0.51MeV$) 
          and the relationship can be expressed by 
          $h\nu^{\prime} \ll m_e c^2$. Therefore, this can be treated as Thompson Scattering process. 
          Let the Poynting vector of incident photons be $\vec{S}^{\prime}$ and their energy density 
          be $U_{rad}^{\prime}$, we have equation \ref{eq: poynting_and_energy_density}
          \begin{equation}
            \label{eq: poynting_and_energy_density}
            \vec{S}^{\prime} = c U_{rad}^{\prime}
          \end{equation}
          The electron absorbs the energy of the incident photons and then be accelerated. Thus the 
          accelerated electron will emit part of energy taken from incoming photons and the power of 
          scattered radiation is denoted as $P^{\prime}$.
          The ratio can be described by Thompson Scattering cross section $\sigma_{T}$ which is:
          \begin{equation}
            \label{eq: thompson_cross_section}
            \sigma_{T} = \frac{8\pi}{3} \left(\frac{e^2}{m_e c^2}\right)^2
          \end{equation}
          and the relationship between the electron radiation power and incoming photon energy flux can be 
          described by the equation \ref{eq: relationship_power_poynting}
          \begin{equation}
            \label{eq: relationship_power_poynting}
            P^{\prime} = \left| \vec{S}^{\prime} \right| \sigma_{T}
          \end{equation}
          Combine the equation \ref{eq: poynting_and_energy_density} and \ref{eq: relationship_power_poynting},
          the radiation power emitted by the electron is: 
          \begin{equation}
            \label{eq: final_relationship}
            P^{\prime} = c \sigma_{T} U^{\prime}_{rad}
          \end{equation}

          Then we need to find the relationship between frame $S$ and $S^{\prime}$. It mainly contains 2 
          parts: the relationship between $P$, $P^{\prime}$ and $U_{rad}$, $U_{rad}^{\prime}$. Since 
          $P = dE/dt$ and $dE/dt$ is Lorentz invariant in inertial frame, we know: 
          \begin{equation}
            \label{eq: power_is_equal}
            P = P^{\prime}
          \end{equation}
          Now we hope to write $U_{rad}^{\prime}$ in terms of $U_{rad}$. $U_{rad}$ is comprised by 
          energy of a single photon and photon density. In the flowing analysis, all the denotations are 
          correspondent to \ref{fig: inverse_compton} According to the relativistic Doppler shift formula,
          we have: 
          \begin{equation}
            \label{eq: doppler_shift}
            h \nu^{\prime} = \left(h \nu\right) \gamma \left(1 + \beta \cos{\theta} \right)
          \end{equation}
          where $\beta = v / c$ and $\gamma$ is Lorentz factor of an ultra-relativistic electron. 
          Then we calculate the photon density. In the frame $S^{\prime}$, the photon density is
          inverse proportional to the time interval ($\Delta t$) between 2 photon strike the electron 
          since total number of photons is Lorentz invariant. In laboratory frame $S$, 
          we consider 2 photons collide with the electron at the 4-dimension vector of 
          $\left(x_{1}, 0, 0, t_{1}\right)$ and $\left(x_{2}, 0, 0, t_{2}\right)$. According to the 
          Lorentz transformation between inertial frames: 
          \begin{equation}
            \label{eq: lorentz_transfer_general}
              \begin{cases}
                 & x = \gamma \left( x^{\prime} + \beta c t^{\prime} \right)\\
                 & y = y^{\prime} \\
                 & z = z^{\prime} \\ 
                 & t = \gamma \left(t^{\prime} + \frac{\beta x^{\prime}}{c}\right)
              \end{cases}       
          \end{equation}
          And since we set $x^{\prime} = 0$, from equation \ref{eq: lorentz_transfer_general}, the 2 
          events of 2 successive photons collide with the electron can be expressed as:
          $\left(\gamma v t_{1}^{\prime}, 0, 0, \gamma t_{1}^{\prime}\right)$ and 
          $\left(\gamma v t_{2}^{\prime}, 0, 0, \gamma t_{2}^{\prime}\right)$. 
          As the Fig \ref{fig: inverse_compton_time_interval} showing, the time interval of two successive 
          photons (reciprocal of frequency) in frame $S$ is: 
          \begin{eqnarray}
            \label{eq: inverse_compton_time_interval}
            \Delta t &=& \left(t_2 - t_1\right) + \frac{\left(x_2 - x_1\right) \cos{\theta}}{c}  \nonumber \\
                     &=& \gamma \left(t_{2}^{\prime} - t_{1}^{\prime}\right) + \frac{\gamma v \left(t_{2}^{\prime} - t_{1}^{\prime}\right) \cos{\theta}}{c} \nonumber \\
                     &=&  \Delta t^{\prime} \gamma \left(1 + \beta \cos{\theta}\right) 
          \end{eqnarray}
          The equation \ref{eq: inverse_compton_time_interval} shows that the relationship of photon number 
          density between frame $S$ and $S^{\prime}$ is:
          \begin{equation}
            \label{eq: inverse_compton_number_density_relationship}
            n^{\prime} = n \gamma \left(1 + \beta \cos{\theta}\right) 
          \end{equation}
          Combine the equation \ref{eq: inverse_compton_number_density_relationship} and 
          \ref{eq: doppler_shift} we can transfer the incident photon energy density from frame $S$ to 
          $S^{\prime}$ according to the equation \ref{eq: inverse_compton_energy_density}
          \begin{equation}
            \label{eq: inverse_compton_energy_density}
            U_{rad}^{\prime} = U_{rad} \left[\gamma \left(1 + \beta \cos{\theta}\right)\right]^{2}
          \end{equation}
          In the equation \ref{eq: inverse_compton_energy_density}, the incoming photon energy density 
          is a function of incident angle ($\theta$), in order to get the total photon energy density,
          we integrate the equation over $\theta$. Then we get: 
          \begin{equation}
            \label{eq: inverse_compton_energy_density_total}
            U_{rad}^{\prime} = \frac{4}{3} U_{rad} \left(\gamma^2 - \frac{1}{4}\right)
          \end{equation}
          By combining the equation \ref{eq: inverse_compton_energy_density_total} and 
          \ref{eq: final_relationship} we know the total scattered radiation power is:
          \begin{eqnarray}
            \label{eq: inverse_compton_power}
            P^{\prime} &=& P  \nonumber \\
                       &=& \frac{4}{3} \sigma_{T} c U_{rad} \left(\gamma^2 - \frac{1}{4}\right)
          \end{eqnarray}
          As mentioned before, $P^{\prime}$ and $P$ are total radiation power after scattering. Before the 
          low energy gain photons, they give away some energy first which is $\sigma_{T} c U_{rad}$. 
          Therefore, we have to subtract this value from the equation \ref{eq: inverse_compton_power} to 
          calculate the rate of net energy gain, which is described by the equation 
          \ref{eq: inverse_compton_net_gain}.
          \begin{eqnarray}
            \label{eq: inverse_compton_net_gain}
            P^{\prime} = P = \frac{dE}{dt} &=& \frac{4}{3} \sigma_{T} c U_{rad} \left(\gamma^2 - \frac{1}{4}\right) - \sigma_{T} c U_{rad} \nonumber \\
                                           &=& \frac{4}{3} \sigma_{T} c U_{rad} \beta^{2} \gamma^{2}
          \end{eqnarray}
          If we compare the equation \ref{eq: inverse_compton_net_gain} with \ref{func: sync_combine}, we 
          find that the form is very similar between these two equations. 
          \begin{equation}
            \label{eq: comparision_inverse_compton_and_sync}
            \frac{P_{IC}}{P_{sync}} = \frac{U_{rad}}{U_{B}}
          \end{equation}
          where $U_{B}$ is the energy density of environment magnetic field. 

          \vspace{1cm}
          \singleFig{inverse_compton_time_interval}{0.45}{Two photons collide with an electron. 
            In the frame $S^{\prime}$, two photons collide with a rest electron successively.
            In the frame $S$, the electron is no longer at rest and the positions of the two events 
            are $x_1$ and $x_2$ \Notice{the Fig.is from internet}}

          \add{spectrum property, shape}

        %end of "IC"
        
          \subsection{A More Sophisticated Model}

              It is oversimplified to regard a pulsar as a magnetized sphere rotating in vacuum. Actually,
              there are plenty of 
              charged particles in a pulsar's magnetosphere which co-rotate with the pulsar. The creation of 
              charged particles can 
              be described by the following steps \cite{Sturrock:1971zc}.

              \indent 1. The co-rotating charged primary particles emit gamma-ray by curvature radiation 
              because of acceleration in super strong magnetic field.  \\
              \indent 2. In super intense magnetic field,  the high energy photons decay into electrons and 
              positrons which are called secondary particles by the process: 
              $\gamma + (B) \rightarrow e^++e^-+(B)$. Synchrotron 
                                  photons can be emitted by these secondary particles. \\
              \indent 3. Secondary particles are also accelerated in strong magnetic field which is just like 
              primary particles. As a result, these charged particles can create more secondary particles. \\
              \indent This chain of process is quite efficient to produce charged particles and pulsar's 
              magnetosphere is filled with plasma as a consequence. So, it is natural to think of the 
              distribution of charges in pulsar's magnetosphere. A characteristic charge density 
              $\rho_{GJ}=-\frac{\vec{\Omega}\cdot \vec{B}}{2\pi c}$ is called Goldreich-Julian density. 
              This charges can offset part of electric field ($E_{\parallel}$) which is parallel to magnetic 
              field. There is some region in the magnetosphere called ``outer gap'' where $\rho_{GJ}$ is so 
              small that it can't screen $E_{\parallel}$ effectively. As a result, the secondary particles can 
              be accelerated at a very large velocity (Lorentz factor $\gamma\sim 10^7$) and emit gamma-ray. 
              Photons in outer gap can also create electrons and positrons by the process: 
              $\gamma+\gamma\rightarrow e^-+e^+$. At the outer gap, one-photon pair production can't happen 
              because magnetic field is too weak in this region.
 
    \section{Millisecond Pulsar} 
        \subsection{P-$\dot{\mathbf{P}}$ Diagram} 
        P-$\dot{\mathrm{P}}$ diagram is an important tool for analyzing evolution of pulsars. 
        Period (P) and time derivative of period ($\dot{\mathrm{P}}$) are two of pulsars' important 
        characteristics. Analyzing the position of a pulsar in P-$\dot{\mathrm{P}}$ diagram can give some 
        valuable information such as which evolution stage the pulsar is in or the type of the pulsar, etc. 
        The Fig.\ref{fig:p-pdot} is an example of  
        P-$\dot{\mathrm{P}}$ diagram. The horizontal axis is pulsars' rotation periods and the vertical axis is 
        time derivative of rotation periods.
        \begin{figure}[h]
            \centering
            \includegraphics[scale=0.45]{{/Users/grewwc/Desktop/Thesis/ppdot.png}}
            \caption{\textit{\footnotesize Position of pulsars in P-}\footnotesize$\dot{P}$ \textit{\footnotesize
                        diagram}}
            \label{fig:p-pdot}
        \end{figure}
        In this P-$\dot{\mathrm{P}}$ diagram, the negative slope lines represent the strength of surface 
        magnetic field while the positive slope lines represent the characteristic age of pulsars. The 
        following is a short explanation for this. From previous discussion, we have known that the 
        characteristic age of a pulsar is $\tau=-P/\dot{P}=P/(-\dot{P})$, so line of constant 
        $\tau$ is a set of straight lines with equal positive slope. We also know $B\propto\sqrt{P\dot{P}}$,
        therefore the line of constant $B$ should be a part of hyperbola. When $\dot{P}$ is very small, the
        hyperbola looks like a straight line with negative slope. \\
        \indent 
        This figure shows that most pulsars lie in the position about $1s, 10^{-14}s/s$.
        At the same time, a couple of stars lie at the bottom-left of the Fig.---these are millisecond
        pulsars (MSP). Their 
        rotation periods are about 1-20 milliseconds. It is believed that MSPs are spun up by accretion of 
        mass from its 
        companion star. In the above P-$\dot{\mathrm{P}}$ diagram, we can observe that millisecond pulsars' 
        surface magnetic field are about 3 to 4 orders of magnitude lower than those of normal pulsars. However,
        an MSP has a relative strong magnetic field near its light cylinder. The reason is that an MSP's radius 
        of light cylinder ($R_{lc}=c/\omega)$ is much smaller than a normal pulsar's because of its short 
        rotation period and the magnetic field near light cylinder can be estimated as 
        $B_{lc}\sim\left(R/R_{lc}\right)^3$. At the same time, pulsars' emission mechanism is closely related 
        to their magnetic field near light cylinder. As a result, like a normal pulsar, an MSP also have 
        broadband spectrum from radio to gamma rays. 
        \subsection{Origin Of Millisecond Pulsars}
            From pulsars' emission mechanism, we know that magnetic field of a pulsar decreases with time while 
            the spin period increase with time. But MSPs' spin period is much shorter than normal pulsars and 
            surface magnetic field is a lot weaker. This makes an MSP seem to be both young and old. As a result,
            people think millisecond pulsars are old pulsars spun up by its companion. The companion star transfer
            mass and angular momentum to accelerate the pulsar. Therefore, the aged pulsar can spin faster 
            gradually. 
            \subsubsection{Mass Transfer And Accretion In Binary Systems}
                X-ray binaries are a type of binary systems that is luminous in X-ray band. There are several kinds 
                of X-ray binaries including low mass X-ray binaries (LMXB) and high mass X-ray binaries (HMXB). 
                The way of transferring mass is different in these two types of systems. Before discussing mass 
                transfer, we need to know a little bit about Roche Lobe. The Fig.\ref{fig:roche lobe} is a 
                schematic diagram of Roche lobe.
                \begin{figure}[h]
                  \centering
                  \includegraphics[scale=0.5]{/Users/grewwc/Desktop/Thesis/roche_lobes.jpg}
                  \caption{\footnotesize \textit{Schematic diagram of Roche lobe.} $L_{1}$ is called inner 
                            Lagrange point which is the intersection of equipotential lines of star A 
                            and B.}
                  \label{fig:roche lobe}
                \end{figure}\\
                \indent  We call two stars in an LMXB as A and B respectively for convenience. It is obvious 
                that if an object is close to star A, the gravitational influence of A is so strong that we can 
                nearly ignore the effect of star B. Similarly, this is true for star B. As a result, there must be 
                a point where the effect of star A is equal to star B which is called inner Lagrange point 
                \cite{0004-637X-603-1-283}. The two
                volumes inside the largest equipotential lines of A and B are called Roche lobe. If star B cross 
                its Roche lobe, than its mass will be attracted by A thus mass transfer between A and B happens. We 
                should notice that this is the main way of mass transfer in LMXB. While in HMXB, the mass can be 
                transferred by strong wind of the massive companion star. \\
                \indent 
                What should be noted is that mass transfer can change the distance between two companion stars. If 
                low-mass star transfer mass to high-mass companion star, the orbital separation will be large. 
                This can actually stop mass transfer and is like negative feedback. 
                On the contrary, mass transfer from high-mass star to low-mass star will shrink the orbital 
                distance.\\
                       
        \subsection{Class II MSPs}
            \begin{figure}[h!]   
                \centering
                \includegraphics[width=6.9cm,height=7.6cm]{{/Users/grewwc/Desktop/Thesis/bands.png}}
                \caption{\textit{\footnotesize Pulse profiles of PSR B1937+21 in radio, X-ray and gamma-ray.}}
                \label{fig:class }
            \end{figure}	 
            Radio emission are usually considered to be emitted above the polar cap, which means radio emission 
            and gamma-ray emission are from different location of pulsar's magnetosphere. However, there are about 
            10 sources showing aligned pulse profiles in radio and gamma-ray implying that radio emission may 
            produced from outer magnetosphere and they are called Class II MSPs \cite{0004-637X-744-1-33}.
			      These pulsars have strong magnetic 
            field near the light cylinder. The Fig.\ref{fig:class } is an example of aligned pulse profile.

    \section{Objectives}
            The three millisecond pulsars J0218+4232, B1821-24 and B1937+21 show 
            broadband spectra in all radio, X-ray and gamma-ray bands. Fermi LAT gives us 
            additional data and tools to do gamma-ray analysis for the pulsars. Lots of research 
            have been done on the three MSPs, however, many of them are a little bit 'old'. In year 
            2015, Fermi team released Pass 8 data including many improvements. According to the 
            \blackhref{https://fermi.gsfc.nasa.gov/ssc/data/analysis/documentation/Pass8_usage.html}{Fermi official website},
            Pass 8 dataset includes improved event construction, better energy measurement and 
            significantly improved effective area. Additionally, we have more observation Fermi LAT
            data. As a result, it is reasonable to redo the gamma-ray analysis with newer dataset and 
            more observation data in order to gain more reliable results. 

            Therefore, my main objective is to use the new tools and data to redo the gamma-ray
            analysis of the three MSPs mentioned above. 
            Then, I will do a numerical simulation based on a theoretical model called two-lay model and test if the new observation 
            data are consistent with the the predictions of the model. And finally, based on numerical simulations 
            of the two-layer emission model, I will generate broadband spectra (including hard X-ray band 
            and gamma-ray band) for all the three MSPs. 

%     \section{NuSTAR}  
%         \textit{NuSTAR} stands for Nuclear Spectroscopic Telescope Array and is launched in June 12, 2012. It is the 
%         first space telescope
%         focusing on hard X-ray (3eV-79eV) band. This is the telescope that we mainly use and it is helpful to know 
%         the structure to deal
%         with its data. It mainly composed of three parts: detectors, optics and mast as the Fig.\ref{fig:nustar}
%         shows.
%         \begin{figure}[h] 
%             \centering
%             \includegraphics[scale=0.6]{{/Users/grewwc/Desktop/Thesis/nustar.png}}
%             \caption{\textit{\footnotesize \textit{NuSTAR}'s sketch. The mast connects X-ray optics and focal plane 
%             detectors.}}
%             \label{fig:nustar}
%         \end{figure}
              
%         \subsection{Detectors} 
%             \textit{NuSTAR} has two independent photons counting detector modules (FPMA \& FPMB) and each module 
%             contains 4 
%             Cadmium-Zinc-Telluride (CZT) detectors. Every detector is a rectangular crystal whose size is 
%             $20mm\times 20mm 
%             \times 2mm$ (length$\times$ width$\times$height) and have $32\times 32$ pixels. \\
%             \begin{figure}[h]  
%                 \hspace{2.3cm} 
%                 \begin{minipage}[c]{0.4\textwidth}
%                     \includegraphics[width=5cm,height=5cm]{{/Users/grewwc/Desktop/Thesis/detector.png}}
%                 \end{minipage}
%                 \hspace{0.5cm} 
%                 \begin{minipage}[c]{0.4\textwidth}
%                     \includegraphics[width=5cm,height=5cm]{{/Users/grewwc/Desktop/Thesis/sheld.png}}
%                 \end{minipage}
%                 \newline
%                 \noindent \hspace*{0.08\linewidth}
%                 \begin{minipage}[c]{0.8\linewidth}
%                 \caption{\textit{\footnotesize Left: One of two detector modules which contains $2\times 2$ array 
%                 of independent detectors.
%                 Right: One detector module shielded by Csl crystal. CZT detectors can turn high 
%                 energy photons into electrons very efficiently in room temperature so they are operated at 
%                 15\textdegree{}C. }}
%                 \end{minipage}
%                 \label{fig:detectors}
%             \end{figure}
%             %\vspace{0.35cm}
%             \indent In order to help to distinguish the source photons and the background photons, the focal 
%             planes are shielded with 
%             crystals made of Celsium-Iodide (Csl). The Csl shields can record the photons come from directions 
%             which are not the 
%             direction of \textit{NuSTAR} optical axis. So background photons can be subtracted from the total photon 
%             counts. 
              
%         \subsection{Optics}
%             Corresponding to two detector modules, \textit{NuSTAR} also has two optics called Optics Module A and B 
%             (OMA \& OMB). The 
%             focal length is 10.14 meters which is about the same length with its mast. X-ray is very hard to 
%             reflect so mirrors are 
%             usually made of high density materials such as Pt and W. Past telescopes such as \textit{Chandra} uses 
%             these high density 
%             materials to reflect low energy X-ray (up to 10eV). However, the efficiency of reflecting high 
%             energy X-ray drops 
%             drastically. High density contrast between two kinds of materials are needed to overcome this
%             problem. As a 
%             result, \textit{NuSTAR}'s mirror is coated with Pt/SiC and W/Si multilayers and can reflect hard X-ray 
%             up to 79eV. 

%             \indent Besides high density contrast between two materials, a small incident angle is also 
%             required. As the Fig.\ref{fig:optics}
%             \begin{figure}[h]
%                 \centering
%                 \includegraphics[scale=0.6]{{/Users/grewwc/Desktop/Thesis/lightscheme.png}}
%                 \caption{\textit{\footnotesize Light path schematic diagram of reflecting X-ray}}
%                 \label{fig:optics}
%             \end{figure}
%             showing, the focal length may be very long because of the small incidence angle. This is partly 
%             the reason why
%             \textit{NuSTAR}'s detectors and optics are separated by a 10-meter long mast which will be introduced in 
%             the next section.
			
%         \subsection{Mast}
%             Although \textit{NuSTAR}'s mast is stable and reliable, it can cause some image distortion because of 
%             its deformation. Therefore, 
%             careful calibration or measurement of mast's deformation is necessary. In order to achieve this, 
%             \textit{NuSTAR} has a laser 
%             metrology system which consists of two lasers and two light-sensing detectors. The two 
%             lasers are located on optics 
%             while the two detectors are mounted on the detector module. Then, the deformation can be recorded 
%             and used to reconstruct the raw data. The Fig.\ref{fig:mast} shows what the mast looks like. The
%             reason why \textit{NuSTAR} has a deployable mast is that it is carried by a relative small rockets.
%             \begin{figure}[h!]
%               \centering
%               \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/nustar_mast.png}
%               \mycaption{\textit{NuSTAR}'s mast. Left: stored in container. Right: after being deployed.}
%               \label{fig:mast}
%             \end{figure}

%         \subsection{Performance of NuSTAR}
%             Though \textit{NuSTAR} has a broad energy range, the effective collecting area at different energy is 
%             quite different. The Fig.\ref{fig:effective_area} shows comparison between \textit{NuSTAR} and other 
%             telescopes.
%             \begin{figure}[h!]
%               \centering
%               \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/effect_area.png}
%               \mycaption{\textit{NuSTAR}'s effective area compared with other X-ray focusing telescopes.}
%               \label{fig:effective_area}
%             \end{figure}
            
%             From figure \ref{fig:effective_area} we can see that the effective area drops dramatically after 70keV.
%             Therefore, we may need to screen out the high energy part ($>$70keV) for data analysis.
%             The Fig.\ref{fig:psf} shows the point spread function (PSF) of optics module A and B. In order to
%             make faint pixels look more obvious, the images are in logarithm scale. The PSF of both optics module A
%             and B are dependent on energy. The table \ref{table:psf_relation} lists the relationships and from this 
%             table we can also see that angular resolution of optics module B is slightly better A.
            
             
%             \begin{figure}[!htp]
%               \centering
%               \includegraphics[scale=0.27]{/Users/grewwc/Desktop/Thesis/psf.png}
%               \mycaption{Image of NuSTAR's point spread function of optics module A(left) and B(right).}
%               \label{fig:psf}
%               \vspace{1.5cm} 
%               \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/psf_relation.png}
%               \mycaption{PSF (half power diameter) as a function of energy.}
%               \label{table:psf_relation}
%             \end{figure}

%         \section{The Procedures of Processing NuSTAR Data}
%             \textit{NuSTAR} Data Analysis Software (\textit{NuSTARDAS}) is used for data processing. This includes 
%             three steps:
%             data calibration, data screening and products extraction. The next paragraph talks about the reason the 
%             first two steps are necessary. 

%             \indent 
%             Lots of factors can affect raw data, such as movements of \textit{NuSTAR}‘s mast, the orbit of the 
%             telescope, 
%             etc. As a result, \textit{NuSTAR} data must be calibrated before they can be used to do data analysis. 
%             Also, some parts 
%             of data are not good for scientific analyzing. For example, there are some bad pixels in the telescope's 
%             detectors which cannot record photons correctly. Thus, the data recorded by these bad pixels have to be
%             treated very carefully. We might get rid of the data when the source is bright, while if the photon counts
%             are too small, we might have to use these data with carefulness. And sometimes we may want to focus on a 
%             particular part of data. Thus, we need to screen the calibrated data. 

%             \indent 
%             In order to understand data filter process better, it is necessary to know the different levels of 
%             \textit{NuSTAR} data. 
%             \textit{NuSTAR} data can be divide into 5 levels which is from level 0 to level 3. Level 0 data are raw 
%             telemetry files
%             which might not be in formal format (FITS format). Level 1 data contains two parts: level 1 and level 
%             1a. Level 1
%             data are formatted in FITS format, but not calibrated yet. Level 1a data are level 1 data after 
%             calibration. 
%             Actually, level 1a data are addition of level 1 data and calibration data. Level 1a data are produced by 
%             step 1 
%             (data calibration). Then by step 2 (data screening), we get level 2 data which are cleaned files. We 
%             can do data
%             analysis after getting level 2 data. Thus in order to get reliable result, it is key to get raw data 
%             properly 
%             cleaned. The Fig.\ref{fig:comparison} is comparison between level 1a event file and level 2 event file 
%             after screening.  

%             \begin{figure}[h] 
%             \vspace{0.2cm}
%                 \begin{minipage}{0.45\textwidth}
%                 \begin{flushright} 
%                 \includegraphics[scale=0.31]{/Users/grewwc/Desktop/Thesis/A_uf.png}
%              %\caption{raw picture}
%             \end{flushright}
%             \end{minipage}
%             \hspace{1cm}
%             \begin{minipage}{0.45\textwidth}
%               \begin{flushleft}
%                 \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/A_cl.png}
%               \end{flushleft} 
%             \end{minipage}
%             \centering
%             \begin{minipage}[c]{0.85\textwidth}
%                 \caption{\textit{\footnotesize Left: sky image generated directly from level 1a data. Right: sky 
%                 image 
%                 generated from screened level 2 data. These two figures are produced from the same raw data. 
%                 There are 
%                 many criteria for data screening and the Fig.in the right is just an example.}}
%                 \label{fig:comparison}
%             \end{minipage}
%             \end{figure}
            
%             \subsection{Data Calibration}   
%                 The first process is data calibration. In this step, two factors should be considered: the temporal 
%                 change 
%                 of mast and spacecraft's attitude. By using telescope's housekeeping files, the corrected data can be 
%                 produced by \textit{NuSTAR} software. There are some \textit{NuSTAR} software modules for this 
%                 process. Most of them are 
%                 nearly automatically, which means once we have initial files, the output files are fixed. 
%                 Therefore, we 
%                 do not concentrate much on these software modules. Before we go into this module, some basic 
%                 concepts should be introduced.

%             \subsubsection{Grade of Data}  
%             When a photon interacts with a detector, the ideal condition is that only one pixel record this photon,
%             which has better spectra resolution than other situations. 
%             But a single X-ray photon can be spread and received by more than one pixel. Generally, the less pixels
%             by which a photon recorded, the better the event is. 
%             Naturally, there are different patterns of interaction between the
%             photon and surrounding pixels. These patterns are listed in figure \ref{fig:nustar_grade}.  
%             \begin{figure}[h] 
%               \centering
%               \includegraphics[scale=0.34]{/Users/grewwc/Desktop/Thesis/grade.png}
%               \begin{minipage}[c]{0.85\textwidth}
%                 \caption{\textit{\footnotesize There are 33 different \textit{NuSTAR} grades---from grade 0 to 32.
%                           In this figure, grades from 0 to 26 are listed because these grades are accepted by 
%                           \textit{NuSTAR} data screening by default. We can further get rid of some grades if needed.}
%                           }
%               \label{fig:nustar_grade}
%               \end{minipage}
              
%             \end{figure}


%             \subsubsection{Status of Data} 
%             Just like flagging the quality of pixel data, it is necessary to flag event data because there are many
%             factors that can trigger detectors. For instance, if we have a photon record in a detector, we need to 
%             know if it is from the source we are observing. Actually, cosmic rays can also trigger the 
%             detectors and we want to get rid of them in order to increase the signal to noise ratio. 
%             Therefore, after we have distinguished them from source photons, it is needed to be recorded for data
%             screening---thus each single event has its status. In fact, similar to data's grade, status of data also
%             has many patterns. For example, an event may fall into bad pixels, have a neighborhood bad pixel
%             or fall into a hot pixel, etc. All these different situations are recorded by a 16-bit binary number and
%             status of good event which is ideal for scientific analysis is all zero (recorded as "b0000000000000000").

            
%             \subsection{Data Screening}  
%               After data calibration, though we know if one event is good or not, bad events are not excluded from 
%               original
%               files. This is the primary reason of doing data screening. There are primarily 3 procedures in this 
%               step.

%               \indent The first one is choosing good time intervals, which means remove some unwanted time 
%               intervals. For 
%               example, when the telescope is in the South Atlantic Anomaly, when the Earth is in the Field Of 
%               View and 
%               when the motion of mast is not well tracked, etc. Sometimes we need to add our own GTI (Good Time 
%               Interval) file to get better cleaned data. 
%               Then remove bad pixels and events flagged as 
%               bad in the 
%               last step (by using the information of data status). At last, choose the proper grade of data 
%               (the default value is 0-26). 

%               \indent The core module in this step is called 'nuscreen' and most of job is done by this software 
%               module.  
%               There are two parameters we mostly focus on---'gradeexpr' and 'statusexpr', which are used for choosing 
%               grade of data and status of data respectively. For example, gradeexpr=0-8 means choosing grade range 
%               from 0 to 8 and statusexpr="STATUS==b000000000x0xx000" means leaving out bad events. We also can set  
%               them to default value by 'statusexpr=DEFAULT' and 'statusexpr=DEFAULT'. By adjusting these parameters' 
%               values, we can get a bunch of cleaned event files. Then we can generate several sky images and 
%               spectra and 
%               choose a better result. 

%              \subsection{Products Extraction}
%               The aim of this process is to extract high-level scientific products including light curves, sky images,
%               spectra, Ancillary Response Files (ARF) and Redistribution Matrix Files (RMF). ARF and RMF files are 
%               used for spectra analysis. The main software module is 'nuproducts' which generates these files 
%               automatically by 
%               passing some parameters. I mainly focus on two parameters which are 'pilow' and 'pihigh'. These two 
%               parameters filter the energy range of cleaned stage 2 event files. The default values of the two 
%               parameters
%               are 39 Pi and 1909 Pi respectively corresponding the \textit{NuSTAR}'s energy range 3-78.4eV. But 
%               usually we 
%               choose pilow larger than 39 and pihigh smaller than 1909 in order to get more reliable data.

% \chapter{Data Analysis}
    
    
%     \section{Data Analysis of Pulsar B1937+21 Using NuSTAR}
%         Usually, we choose all the parameters to be default values. We may change some of the parameters in certain 
%         cases. 
%         Then we can produce a complete set of stage 2 files by using the module 'nupipeline'. The following is 
%         the sky images from \textit{NuSTAR}'s module A and module B. 
%         \begin{figure}[h]
%           \hspace{0.7cm}
%           \begin{minipage}{0.45\textwidth} 
%             \centering 
%             \includegraphics[scale=0.33]{/Users/grewwc/Desktop/Thesis/A01.png}
%             \caption{\textit{\footnotesize Sky image of module A}}
%           \end{minipage}
%           \hspace{0.1cm} 
%           \begin{minipage}{0.52\textwidth}
%             \centering 
%             \includegraphics[scale=0.39]{/Users/grewwc/Desktop/Thesis/B01.png}
%             \caption{\textit{\footnotesize Sky image of module B}}
%           \end{minipage}
%         \end{figure}
      
%         Although there are lots of background noises in these two pictures, the source is clearly identifiable. 
%         We can obviously see the differences between these two figures. For example, the source is sharper in the 
%         right figure. Actually, from figure \ref{table:psf_relation} we can see that the PSF (half power diameter) of
%         module B is slightly smaller than that of module A in each energy range. 
%         The focal plane module comprises 4 detectors, but in these figures we can barely distinguish different 
%         detectors. This implies that the data are not calibrated and screened well enough. 

%         \indent After getting cleaned stage 2 files, we can continue to generate light curves, spectra and so on. 
%         Before doing these, it is required to choose source and background regions. The Fig.\ref{fig:sky0}
%         show the regions we choose.  

%         \begin{figure}[h]
%           \begin{minipage}{0.45\textwidth} 
%             \begin{flushright} 
%             \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/A01_region.png}
%             \end{flushright}
%           \end{minipage}
%           \hspace{2.1cm}  
%           \begin{minipage}{0.45\textwidth}
%             \begin{flushleft}
%             \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/B01_region.png}
%             \end{flushleft}
%           \end{minipage}
%           \begin{center}
%           \begin{minipage}{0.85\textwidth}
%             \vspace{0.25cm}
%             \mycaption{Source and background regions of module A (left) and B (right).}
%             \label{fig:sky0}
%           \end{minipage}
%         \end{center}
%         \end{figure}
%         \indent In figure \ref{fig:sky0}, the left green circle is source region while the right green 
%         circle is 
%         background region. The center of source circle is (19:39:38.561 ra, +21:34:59.126 dec) and the radius is 
%         23 arcseconds. The center of the background region is (19:39:12:412 ra, +21:35:29.210 dec) and the radius is 
%         34.140 arcseconds. We call the choice of the source and background region as "region 1".
%         The data of the source region center is from
%         \href{http://www.atnf.csiro.au/people/pulsar/psrcat/proc\_form.php?version=1.56&startUserDefined=true&c1\_val%
%         =&c2\_val=&c3\_val=&c4\_val=&sort\_attr=jname&sort\_order=asc&condition=&pulsar\_names=b1937\%2B21\%0D\%0A&ep%
%         hemeris=short&submit\_ephemeris=Get+Ephemeris&coords\_unit=raj\%2Fdecj&radius=&coords\_1=&coords\_2=&style=%
%         Long+with+last+digit+error&no\_value=*&fsize=3&x\_axis=&x\_scale=linear&y\_axis=&y\_scale=linear&state=query}%
%         {\textit{ATNF}}
%         (Australia Telescope National Facility). From the Fig.\ref{fig:sky0} we can see that the source we 
%         observed is actually the right source---B1937+21. This means that the observation data can be used to analyse 
%         the pulsar B1937+21. However, for module B, the position observed source is a little bit away from the 
%         ATNF data. This means that we might need 2 sets of source and background regions for module A and module B
%         respectively.

%         \indent  
%         The Fig.s \ref{fig:lightcurve_a} and \ref{fig:lightcurve_b} are the light curves of module A and B.
%         These light curves are generated using ds9 software. The time interval of each bin is 50 seconds.
%         The horizontal axis is time and the vertical axis is proportional to count rate. 
%         Although these pictures show  periodicities, it does not mean that we can do timing analysis for B1937+21 
%         by using \textit{NuSTAR}. The reason is that the time resolution of \textit{NuSTAR} is about 2 $ms$ which
%         is larger than the spin period of B1937+21 ($\sim$1.56ms). In fact, I think the periodicity reflect the 
%         \textit{NuSTAR}'s orbital information to some extent. \textit{NuSTAR}'s orbit is very low (the semi major
%         axis is about 7000km) so its observation will be greatly influenced by the Earth. When the source is blocked
%         by the Earth, the count rate is zero (after data calibration and screen) \\
%         \begin{figure}[h]
%           \begin{minipage}{\textwidth}
%             \begin{center}
%                 \includegraphics[scale=0.31]{/Users/grewwc/Desktop/Thesis/A_lc.png}
%                 \mycaption{Light curve of module A}
%                 \label{fig:lightcurve_a}
%               \end{center}
%             \end{minipage}
%          \\ 
%           \begin{minipage}{\textwidth}
%             \centering
%             \includegraphics[scale=0.34]{/Users/grewwc/Desktop/Thesis/B_lc.png}
%           \mycaption{Light curve of module B}
%           \label{fig:lightcurve_b}
%           \end{minipage}
%         \end{figure}\\
%         \indent 
%         The Fig.\ref{spectra} is the spectra of module A and B. The group counts of both module A and B are
%         20 and the fitting model is multiplication of absorption of X-ray model (see in sherpa document 
%         \href{http://%
%         cxc.harvard.edu/sherpa/ahelp/xstbabs.html}{'xstbabs'}) and 1 dimensional power law model (see also in sherpa 
%         document\href{http://cxc.harvard.edu/sherpa/ahelp/powlaw1d.html}{'powlaw1d'}). We use chi square statistics
%         to analyze goodness of fitting.\\

%         %add a parameter table here.
%         \begin{table}[!h] 
%           \centering
%           \begin{tabular}{| m{4cm} | m{3cm} | m{3cm} |}
%             \hline
%             & Module A & Module B \\
%             \hline
%             Column Density (nH) ($10^{22} atoms/cm^2$) & 4.06 & 0.012\\ 
%             \hline
%             Photon Index ($\Gamma$) & 1.33 & 1.46 \\
%             \hline 
%             Reduced Chi Square Statistic & 0.33 & 0.30 \\
%             \hline 
%           \end{tabular}
%           \mycaption{Fitting result  }
%           \label{table:parameter_1}
%         \end{table}

%         \indent
%         The table \ref{table:parameter_1} lists some important parameters of the fitting result. 
%         The number of total points in spectrum of module A and B are both 11. For the spectrum of A, the 
%         reduced statistic is about 0.33 and Q-value is about 0.95. The fitted column density is about 
%         $4.06\times 10^{22} atoms/cm^2$ and the photon index is 1.33. For the spectrum of B, the reduced statistic is
%         0.30 and Q-value is about 0.97. The column density is about 0.012 and photon index is 1.46. We observed that
%         the column density difference between module A and B are huge (module A is about 400 times larger than 
%         module B). This 
%         is because that the high energy X-ray photons are nearly not absorbed by interstellar medium. As a result, 
%         the column density fitted only by \textit{NuSTAR} (3$\sim$79eV) reliable so we need to combine 

%         \textit{NuSTAR} data and \textit{Chandra} and \textit{XMM-Newton} data together to fit.\\ 
%         \begin{figure}[h]
%           \begin{minipage}{0.45\textwidth}
%             \begin{center} 
%                 \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/a_1.png}
%             \end{center}
%             \end{minipage}
%           \begin{minipage}{0.45\textwidth}
%             \begin{center}
%             \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/b_1.png}
%             \end{center}
%           \end{minipage}
%           \centering
%           \begin{minipage}{0.8\textwidth}
%           \mycaption{Spectra of module A (left) and B (right). The total source counts of A before grouping is 
%                       301 and B is 286. After subtracting background, the source counts of A is 193.45 and B is
%                       170.25. Reduced chi square statistic: 0.33 (A) and 0.3 (B).}
%           \label{spectra}
%           \end{minipage}
%           \end{figure}
%           \\
%         \subsection*{Some Analysis}
%           \indent There are actually some problems in the whole precess. First of all, the regions is not properly 
%             chosen. Although we can see that the pulsar is completely in the source region, it is not in the center of 
%             the source region (especially for module B). As for the background region, it is a little bit small. 
%             In addition, there are four 
%             detectors so it is better to choose the background and source region in the same detector. 

%         \indent Secondly, there are many spikes in light curves of both module A and B. 
%         Therefore we may need to clean the data
%         more carefully. One straightforward way is to add our own GTI file rather than only using the default GTI 
%         file. Thirdly, the reduced statistic values for module A and B are 0.33 and 0.30 respectively, which are 
%         a little bit small. It means that our model is overfitted and the result seems to be too good to happen. In 
%         general, our model is good if reduced chi square statistic is about 1. Thus, we need to rethink how we 
%         should screen the data.


%         \indent 
%         In short, we are focusing on the two things: change the source and background regions and filter the 
%         light curves by adding our own GTI file. 

%         \indent
%         At first, we need to change the source and background regions. The Fig.\ref{fig:region2} shows the 
%         region we choose this time. There are three major changes of the chosen regions. First of all, we slightly 
%         adjust the center of the source region in order to make the observed source be the center of the source 
%         region. The center is (19:39:38.101 ra, +24:34:56.838 dec). 
%         We do not change the radius of the source region so the radius is still 23 arcseconds. Secondly, we change 
%         the position of the background region and make it in the same region with the observed source. The center of the 
%         background region is (19:39:38.003 ra, +21:34:57.657 dec). The inner and outer radius (the background region
%         is an annulus) are 40 arcseconds and 100 arcseconds respectively. 
%         The reason we choose the background region is that  
%         \textit{NuSTAR} has 4 detectors and we want to get rid of the influence of instinct differences between the 
%         4 detectors. Thirdly, we change the shape of background region from a circle to an annulus. Just as before, 
%         we call this choice of region as "region 2". The aim is to 
%         make the background region surround the observed source to be more like the background of the source.\\ 

%         \begin{figure}[!ht]
%           \begin{minipage}{0.45\textwidth}
%             \begin{flushleft} 
%               \includegraphics[scale=0.36]{/Users/grewwc/Desktop/Thesis/A_region2.png}
%             \end{flushleft}
%             \end{minipage}
%           \begin{minipage}{0.45\textwidth}
%             \begin{flushleft}
%               \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/B_region2.png}
%             \end{flushleft}
%           \end{minipage}
%           \centering
%           \begin{minipage}{0.8\textwidth}
%           \mycaption{Source and background regions of module A (left) and module B (right).}
%           \label{fig:region2}
%           \end{minipage}
%         \end{figure}
        
%         \indent At first glance, it seems that this time we choose the source and background region reasonably. But 
%         there %
%         are also some problems just as the following figure \ref{fig:problems} showing. The \textit{NuSTAR} is 
%         composed of 4 separate detectors that work independently with each other. Therefore, we should make sure that
%         the background region we choose does not cross the border of one detector. Thus, we change the background 
%         region to the "region 3" as the right part of the following figures show (figure
%         \ref{fig:problems}) and keep on using the "region 3" in the following discussion of this section. Meanwhile,
%         because we want to try to do timing analysis, barycenter correction is also applied in the following 
%         analysis. So far, we have changed 2 things: background region and barycenter correction. 

%         \begin{figure}[!ht]
%           \begin{minipage}{0.45\textwidth}
%             \begin{center} 
%                 \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/region2_problem.png}
%             \end{center}
%             \end{minipage}
%           \begin{minipage}{0.45\textwidth}
%             \begin{center}
%             \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/bkregion_3.png}
%             \end{center}
%           \end{minipage}
%           \centering
%           \begin{minipage}{0.8\textwidth}
%             \mycaption{The problems of the annulus background region (denote as "region 2", \textit{left}) and the 
%             background region we choose again (denote as "region 3", \textit{right}).}
%           \label{fig:problems}
%           \end{minipage}
%         \end{figure}

%         \indent The Fig.s \ref{fig:a_1_region3_lightcurve} and \ref{fig:b_1_region3_lightcurve} are the light 
%         curves 
%         of the module A and B respectively after changing the source and background regions. The bin time is 
%         also 50 seconds. The horizontal axis represents time and the vertical axis represents count rates. 
%         Actually there is no obvious improvement in light curves after we change the source and background regions
%         --- there are also some spikes in the light curves. In order to get rid of those high spikes, we add some 
%         GTI files to filter the event file. 

%         \begin{figure}[!ht]  
%           \begin{minipage}{1\textwidth}
%             \begin{center} 
%                 \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/lc_a_region3.png}
%                 \mycaption{Light curve of module A}
%                 \label{fig:a_1_region3_lightcurve}
%             \end{center}
%             \end{minipage}
%             \\
%           \begin{minipage}{1\textwidth}
%             \begin{center}
%             \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/lc_b_region3.png}
%             \mycaption{Light curve of module B}
%             \label{fig:b_1_region3_lightcurve}
%             \end{center}
%           \end{minipage}
%           \centering
%         \end{figure}
%         \begin{table}[!h]   
%           \centering
%           \begin{tabular}{| m{4cm} | m{3cm} | m{3cm} |}
%             \hline
%             & Module A & Module B \\
%             \hline
%             Column Density (nH) ($10^{22} atoms/cm^2$) & 6.46$\times10^{-6}$ & 1.75$\times10^{-5}$\\ 
%             \hline
%             Photon Index ($\Gamma$) & 1.10 & 1.53 \\
%             \hline 
%             Reduced Chi Square Statistic & 0.74 & 0.53 \\
%             \hline 
%           \end{tabular}
%           \mycaption{Fitting result}
%           \label{table:parameter_region3}
%         \end{table}
        
%         \indent The Fig.\ref{fig:spectra_region3} is the spectra of module A and B. The table 
%         \ref{table:parameter_region3}
%         show some key parameters of fitting result. The fit model and method 
%         are the same as before. For module A, the reduced chi square statistic value is about 0.73 and Q-value is 
%         0.65. For module B, the reduced chi square statistic is about 0.51 and Q-value is 0.83. After changing the 
%         source and background regions, the reduced chi square statistic values of both module A and B are greatly 
%         increased while the Q-values are largely decreased. This means that the observation data is less overfitted
%         by our model, which generally is a better result.  

%         \begin{figure}[!ht]
%           \begin{minipage}{0.45\textwidth}
%             \begin{center} 
%                 \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/spec_a.png}
%             \end{center}
%             \end{minipage}
%           \begin{minipage}{0.45\textwidth}
%             \begin{center}
%             \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/spec_b.png}
%             \end{center}
%           \end{minipage}
%           \centering
%           \begin{minipage}{0.8\textwidth}
%           \mycaption{Spectra of module A (left) and B (right). The total source counts of A before grouping is 
%                       264 and B is 254. After subtracting the background counts, the source counts are 188.23 (A)
%                       and 161.97 (B). Reduced chi square statistic: 0.74 (A) and 0.53 (B).}
%           \label{fig:spectra_region3}
%           \end{minipage}
%           \end{figure}
        
%         \indent Now we consider using our own GTI file to filter the light curves we get before in order to get 
%         rid of spikes.
%         We use \href{http://cxc.harvard.edu/ciao/ahelp/dmextract.html}{"dmextract"} and 
%         \href{http://cxc.harvard.edu/ciao/ahelp/deflare.html}{"deflare"} tools to extract GTI files. The Fig.s 
%         \ref{fig:a_gti} and \ref{fig:b_gti} are the light curves after filtering event files by our own GTI files. 
%         \begin{figure}[!ht] 
%           \begin{minipage}{1\textwidth}
%             \begin{center} 
%                 \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/a_gti.png}
%                 \mycaption{Light curve of module A after adding our own GTI file}
%                 \label{fig:a_gti}
%             \end{center}
%             \end{minipage}
%             \\
%           \begin{minipage}{1\textwidth}
%           \begin{center}
%             \includegraphics[scale=0.42]{/Users/grewwc/Desktop/Thesis/b_gti.png}
%             \mycaption{Light curve of module B after adding our own GTI file}
%             \label{fig:b_gti}
%             \end{center}
%           \end{minipage}
%           \centering
%         \end{figure}

%         \indent The above light curves look much better than the previous light curves 
%         (figure \ref{fig:a_gti} 
%         and figure \ref{fig:b_gti}). All extremely high spikes are removed. We also have 
%         applied barycenter
%         correction in this step. After adding the GTI file, the cleaned event files are changed too. As a result, 
%         the spectra should also have some changes. The Fig.s \ref{fig:spectra_usrgti}
%         are spectra produced by using GTI files we generated.  

%         \begin{figure}[!ht] 
%           \begin{minipage}{0.45\textwidth}
%             \begin{flushleft} 
%                 \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/spec_usrgti_a.png}
%             \end{flushleft}
%             \end{minipage}
%           \begin{minipage}{0.45\textwidth}
%             \begin{flushleft}
%             \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/spec_usrgti_b.png}
%             \end{flushleft}
%           \end{minipage}
%           \centering
%           \begin{minipage}{0.8\textwidth}
%           \mycaption{Spectra of module A (left) and B (right) after adding our own GTI files. 
%                     The total source counts of A before subtracting background is 238 and B is 211. 
%                     After subtracting background counts, 
%                     the source counts of A is 177.78 and B is 139.46. Reduced chi square statistic: 1.13 (A) and 
%                     0.98 (B).}
%           \label{fig:spectra_usrgti}
%           \end{minipage}
%           \end{figure}

%           \indent The table \ref{table:spectra_usrgti} shows some critical parameters of the fitting result. 
%           We can see that adding our own defined GTI file will apparently affect the result of spectra fitting. 
%           The photon index change from 1.10 to 1.20 for module A while the photon index change from 1.53 to 
%           1.48. Besides, the chi square statistic changes dramatically for both module A and B (nearly doubled).
%           We notice that the column density for module A and B differs greatly. 
%           I think we can ignore this for now because hard X-ray is nearly not affected by
%           interstellar medium. We will care about column density after combined with other telescopes data such 
%           as Chandra. 

%           \begin{table}[!h]   
%             \centering
%             \begin{tabular}{| m{4cm} | m{3cm} | m{3cm} |}
%               \hline
%               & Module A & Module B\\
%               \hline
%               Column Density (nH) ($10^{22} atoms/cm^2$) & 7.57 & $4.65\times10^{-8}$\\ 
%               \hline
%               Photon Index($\Gamma$) & 1.20 & 1.48 \\
%               \hline 
%               Reduced Chi Square Statistic & 1.13 & 0.98 \\
%               \hline 
%             \end{tabular}
%             \mycaption{Fitting result with user defined GTI files}
%             \label{table:spectra_usrgti}
%           \end{table}

%           Then, we want to combine the module A and B data to fit the spectra together. This leads to a question.
%           We know that there are some intrinsic differences between module A and B of \textit{NuSTAR}. As a result,
%           how do we combine two modules together to generate one spectrum? There are two ways of doing this. Firstly,
%           we can directly fit the spectra of these two modules with one single model. Secondly, we can add a 
%           constant between module A and B to represent the differences. % The following figures \ref{} are the result.


%another chapter
  \chapter{Gamma-Ray Analysis}
      As mentioned before, because of the very short rotation periods, MSPs have very small light cylinder radii 
      compared with normal pulsars. As a result, their emission mechanisms are similar to normal pulsars, 
      especially for my target objects --- PSR J0218+4232, PSR B1937+21 and PSr B1821-24, 
      which are among the fastest spinning MSPs. Therefore, as normal pulsars, these three 
      MSPs have broadband emission so it is convenient for us to analyze the spectra 
      properties of them in gamma-ray band.
  
      \section{Introduction of The Fermi Gamma-ray Space Telescope}
        The Fermi Gamma-ray Space Telescope was launched on June 11, 2008 and opened a new window of studying
        supermassive black-hole systems, pulsars and so on. Its original name was Gamma-ray Large Area Space 
        Telescope (GLAST) and changed to Fermi Gamma-ray Space Telescope in honor of the great scientist 
        Enrico Fermi. 

        The Fermi Gamma-ray Space Telescope contains two parts: Gamma-ray Burst Monitor (GBM) and Large 
        Area Telescope (LAT), which is the primary component and is at least 30 times more sensitive than 
        all gamma-ray telescopes launched before. We only use LAT for our purposes. Thus we 
        focus on the LAT instrument, which contains four main subcomponents including tracker, calorimeter,
        anti-coincidence detector and data acquisition system. The reason why the telescope is designed in 
        this way is that high-energy gamma-rays cannot be refracted by lens or mirrors. As a result, the way
        that the Fermi LAT operates is totally different. 

        \begin{figure}[!ht]  
          \begin{minipage}{0.8\textwidth}
            \begin{center} 
                \includegraphics[scale=0.7]{/Users/grewwc/Desktop/Thesis/Gamma_telescope_schematic.png}
                \mycaption{The figure illustrates how Fermi LAT tracks incident gamma-ray photons.}
                \label{fig:fermi schematic}
            \end{center}
          \end{minipage}
        \end{figure}
        The following figure \ref{fig:fermi schematic} demonstrates the very basic idea of the Fermi LAT working
        principles. \\

        \begin{itemize}
          \item Gamma-ray photons can enter the anti-coincidence detector freely while cosmic-rays will generate
            signals which then tell the data acquisition system component to reject these particles. 
            In this way, the 
            Fermi LAT can distinguish the gamma-ray photons and high energy cosmic-rays and the confidence is 
            over 99.9\%. 
          \item The conversion foil (shown in the Fig.\ref{fig:fermi schematic}) can convert the 
            gamma-ray photons into electron and positron pairs. This procedure makes it possible to determine 
            the directions of the incident gamma-ray photons. 
          \item The tracker (particle tracking detectors in the Fig.\ref{fig:fermi schematic}) records the 
            positions of the electrons and positrons generated from the gamma-ray photons. There are many 
            trackers so the paths of a particle can be constructed by doing computational simulations.
          \item The electrons and positrons reach the calorimeter hence their energies are also measured.
            Therefore, the energies of the original gamma-ray photons can also be calculated. 
          \item The data acquisition system is like filter of gamma-ray photons which can 
            reject unwanted particles such as cosmic-rays.
            Also, photons come from the Earth's astronomers are also rejected. 
        \end{itemize}

        For a telescope, the ability of measuring the direction of incident light and energy of photons is very crucial. 
        From the above descriptions of the Fermi LAT working principles, we know that the preciseness of 
        construction of particles' path heavily influences how good we can measure the directions and energies of 
        gamma-ray photons. 
        And this process is greatly dependent on computer simulation algorithms, which means that with the 
        improvements of algorithms,
        the sensitivity of the telescope can also be improved. The Pass 8 data was released on June 24, 2015.
        It has reprocessed the entire Fermi mission dataset so the quality of the dataset is much better. 
        This is part of the reason why I redo the analysis of the three MSPs.

        \section{A Brief Introduction of Fermi Data Analysis}
          We not only want to analyze observation data from Fermi LAT but also study spectra 
          models of our interested sources. We do gamma-ray spectra analysis by comparing our model with 
          the observation data based on the maximum likelihood principal. 

          When doing Fermi LAT data analysis, we basically dealing with 2 "threads". The first is 
          processing observation data and the second is generating photon distribution based on 
          our models. Cleaning data is straightforward including data selection, data filtering with 
          good time intervals(GTI), generating count maps and so on. Generating model-based count 
          maps and count cubes needs a little bit more efforts and mainly includes the following 
          procedures. 

          Firstly, we need to generate a spectra model of all sources in our region of interest (ROI).
          The model basically describes how strong each source is in different energy bands and 
          different positions. The initial parameters of the model is from Fermi database we do not fit 
          positions of both point sources and diffuse sources when do the data analysis. 
          However, the model alone is not very helpful and we have to know other 
          informations in order to get simulated photon distribution. 

          Since we are going to compare our simulation with the observation data, we have to 
          take the telescope states into account. For example, 
          effective area of telescope decreases when we are away from the optical axis. 
          In addition, inclination angles and observation time have a direct influence on the 
          number of photon counts. In short, after we get the simulated photon distribution from 
          our model, we have to transfer the simulation into the "real simulation" by applying 
          the telescope functions. 
          
          After we get the photon distribution and spectra simulation, 
          we can then do comparisons in order to get 
          the maximum likelihood. We divide the total energy band into many smaller bins and denote
          the number of photon counts in observation data as $n_{i}$, so that $\sum_{i}^{}n_{i} = N$, 
          where $N$ is the total number of photons we observed. The observed number of photon counts
          in $ith$ bin is a Poisson distribution with a mean of $m_{i}$. Actually, the value $m_{i}$ is the 
          expected number of photon counts from our spectra model. Therefore, the distribution for $ith$ bin
          can be expressed by the function \ref{func: maximum_likelihood_poisson}, where 
          $P_{i}\left(n_{i}\right)$ is the possibility of observing the $n_{i}$ photon counts for the $ith$
          bin. 
          \begin{equation}
            P_{i}\left(n_{i}\right) = \frac{e^{-m_{i}} m_{i}^{n_{i}}}{n_{i}!}
            \label{func: maximum_likelihood_poisson}
          \end{equation}

          As a result, it is not hard to generalize the possibility for each bin to all bins, just 
          by multiplying the possibilities for different bins.
          \begin{eqnarray}
            P_{total} &=& \prod_{i}^{}P_{i}\left(n_{i}\right) \nonumber \\ 
                      &=& e^{\sum_{i}^{}m_i}\prod_{i}^{}\frac{m_{i}^{n_i}}{n_i!}
            \label{func: maximum_likelihood_poisson_all}
          \end{eqnarray}
          In the function \ref{func: maximum_likelihood_poisson_all}, $n_i$s are directly 
          from observation data so they usually can not be changed during the binned likelihood 
          analysis. However, by changing our model, the $m_i$s can be altered. 
          Hence, our aim is to tweak the spectra model in order to make the total possibility 
          $P_{total}$ as large as possible. 

          This is the basic idea and procedure of doing Fermi data analysis. After doing these,
          we can go further such as testing how significant our targets are by creating TS maps. The 
          thesis basically follows the procedures. 

          Before finishing this part, we should briefly introduce the basic idea of TS maps. 
          TS stands for "Test Statistic" which can be expressed as the function \ref{func: ts_definition}
          \begin{equation}
            TS = -2 \ln{\frac{L_{max,0}}{L_{max,1}}}
            \label{func: ts_definition}
          \end{equation}
          where $L_{max,0}$ and $L_{max,1}$ is the maximum likelihood of models in which our 
          target source is not included and included respectively. According to the function 
          \ref{func: ts_definition}, the larger the TS value is, the larger $L_{max, 1}$ is, which
          means that the probability of existence of our target source is bigger. 
          In order to generate a TS map, we divide the whole map into many sub-grids. In each sub-grid,
          the algorithm basically does 2 things. The first procedure is calculating the maximum likelihood value
          directly based on our spectra model ($L_{max,0}$). Then it adds an imaginary source, fits the source 
          and gets the maximum likelihood ($L_{max, 1}$) value. Therefore, we have two maximum likelihood values.
          In the end, it calculate the TS value for the 
          sub-grid according to the function \ref{func: ts_definition}. 

          After having the TS values for each sub-grids, we can generate a TS map just by 
          rendering colors according to the each grid's TS value. By comparing TS values of 
          each grid in a TS map, we can 
          determine where our target source is most likely to be and how large the probability is. 
          
          Generally speaking, for each source, we generate two TS maps and determine how likely our target source
          is observed. For example, if the data show we have observed the source, then the value of each pixel
          of the TS map containing the source should be low. On the contrary, the TS values of the pixels around 
          the position of our target source should be significantly higher than other positions in the other TS map.
          
          
        \section{Analysis With Fermi LAT}
          In this section, the main objective is to show the results of our gamma-ray spectra analysis. 
          Before doing so, it is appropriate to briefly introduce some terminologies. 
        \begin{itemize}
          \item The most basic idea is creating count maps. 
            A count map is basically generated by the following steps. Firstly we choose a 
            pixel with a certain size. Then we check each photon's direction to determine if the photon is in this 
            pixel. If it is in the pixel, the photon counts of the pixel will add one. Therefore more photons fall within 
            the pixel, the more photon counts the pixel has, hence the brighter the pixel is. By doing the same thing 
            for every pixel in the ROI, a count map can be generated. 
            A count map let us know what we have observed intuitively and 
            gives us a very basic idea of if we get the desired data. 
          \item A count cube is very similar to a count map, except that a count cube contains many energy
            bands. For example, a dataset whose energy is from 100MeV to 100GeV can be divided into 30 bins. We can
            generate a count map in each energy bin, thus we have 30 count maps. In other words, we can regard a 
            count cube as a combination of multiple count maps. A count cube's advantage over a count map is that we can 
            observe distribution of gamma-ray photons in different energy ranges. 
          \item TS value provides us a way to test if our target source is observed as discussed previously.
            In short, a larger TS value statistically means that our aimed source is observed. 
          % \item \mayAdd{may have more items}
        \end{itemize}

        The basic idea of fitting spectra parameters is to make the count cube generated by the model be as similar 
        to the observation data as possible. The calculation process can be summarized as follows. First of all, we 
        have to generate a spectral model for every source in the region of interest (ROI) based on the Fermi database.
        The database includes LAT four-year Point Source Catalog (3FGL), Galactic diffuse emission (gll\_iem\_v06.fits)
        and isotropic emission (iso\_P8R2\_SOURCE\_V6\_v06.txt). 
        Then we can produce a count cube based on the model. Generally speaking, the difference of the 
        count cubes between the model and observation is obvious. Then, the Fermi software adjusts the parameters 
        to make the difference be smaller. Until the errors are acceptable, the software outputs the final fitted 
        parameters of corresponding spectral models.  

        We use a power-law-exponential-cutoff (PLExpCutoff) model to fit the observation data and 
        it is a special case of power-law-super-exponential-cutoff (PLSuperExpCutoff) model. 
        The spectrum of PLSuperExpCutoff can be described by the function \ref{eq: fermi_model}:  
        \begin{equation} 
          \label{eq: fermi_model}
          \frac{dN}{dE} = N_{0} \left(\frac{E}{E_0}\right)^{\gamma_1} 
          exp\left(-\left(\frac{E}{E_c}\right)^{\gamma_2}\right)
        \end{equation}
        where $N_0$ is prefactor, $E_c$ is the cutoff energy and the $E_0$ is a scale parameter. 
        PLExpCutoff model is the special case where $\gamma_2=1$. Our aim is to fit the parameters 
        $N_0$, $E_c$ and $\gamma_1$ to make the model be more consistent with the observation data.

        \subsection{Correctness Verification of Data Processing}
          Before analyzing the observation of our target sources, it is reasonable to test if our procedures of 
          data processing are right or not. In order to do so, I try to do analysis for 
          2 pulsars whose names are J0007+7303 and J0534+2200. The reason I choose these two pulsars 
          is that according to previous studies, they are bright and easy to detect with a large TS value --- 
          the TS values are 43388 and 102653 for J0007+7303 and J0534+2200 respectively. 
          The data can be found on the paper. \cite{0067-0049-208-2-17} 

          In the spectra fit process, we do not use the same fit parameters as the paper, (for instance, 
          the number of free parameters in the ROI is different)
          however, I get very similar results as the table \ref{table: previous_result_comparison} shown. 
          In the table \ref{table: previous_result_comparison}, we use the observation data from 
          2009-01-01 to 2013-02-01 in order to try to be 
          consistent with the old paper \cite{0067-0049-208-2-17}. 
          In addition, we also fit spectra with observation data up to 2018-02-01 and Pass 8 data to test 
          how much improvement we can make with the new Fermi dataset and more observation data. 
          The results of year 2018 data are showed in the table \ref{table: 2018_fit_data}.

          The table \ref{table: previous_result_comparison} and table \ref{table: 2018_fit_data} mainly 
          show 2 pieces of information. Firstly, my procedure of dealing with observation data has no
          big problems, so basically I can trust fit results of my target sources. Secondly, the Fermi 
          Pass 8 Lat Data has improves the accuracy a lot. For example, as the table 
          \ref{table: previous_result_comparison} showing, the photon indexes are 
          $1.30\pm0.02$ and $1.4\pm0.1$, which means that the errors reduce a lot. Additionally, the TS 
          value is more than double as before. 
          \vspace{1cm} 
          \begin{table}[!ht]
            \centering
            \begin{tabular}{|c|c|c|c|c|c|c|} 
              \hline 
              & \multicolumn{3}{|c|}{Test} & \multicolumn{3}{|c|}{Paper} \\ 
              \cline{2-7}
              & $\Gamma$ & $E_c$ (MeV) & TS & $\Gamma$ & $E_c$ (MeV) & TS \\ 
              \hline
              J0007+7303 & $1.30\pm0.02$ & $2010\pm85$ & $96979$ & $1.4\pm0.1$ & $4700\pm200$ & $43388$  \\
              \hline 
              J0534+2200 & $2.07\pm0.01$ & $9880\pm572$ & $239015$ & $1.9\pm0.1$ & $4200\pm200$ & $102653$  \\
              \hline
            \end{tabular}
            \vspace{0.5cm}
              \centering
              \mycaption{The Spectra Fit Results. In the thesis, in order to make data analysis be more 
                convinient, we use some pipeline scripts to deal with the observation data. 
                The "Test" column
                shows the results generated by using the pipeline scripts. The "Paper" column lists the 
                corresponding spectra properties based on the old paper \cite{0067-0049-208-2-17}.
                According to the standard PLSuperExpCutoff model (described in equation \ref{eq: fermi_model}, 
                $\Gamma$ is photon index and $E_c$ is cutoff energy.)}
              \change{the width of the table is larger than width of page}
              \label{table: previous_result_comparison}
          \end{table}
          \vspace{1cm}            

          \begin{table}[!ht]
            \centering
            \begin{tabular}{|c|c|c|c|}
              \hline 
              &$\Gamma$& $E_c$ (MeV) & TS \\ \hline 
              J0007+7303 & $1.34\pm0.02$ & $2204\pm67$ & $210166$ \\ \hline 
              J0534+2200 & $2.01\pm0.01$ & $9173\pm372$ & $449946$ \\ \hline
            \end{tabular}
            \mycaption{Fit Results With Data From Year 2009 To Year 2018. The physical meanings of 
            $\Gamma$ and $E_c$ are the same as the table \ref{table: previous_result_comparison}.}
            \label{table: 2018_fit_data}
          \end{table}
          \vspace{1cm}            
            

        \subsection{PSR J0218+4232}
          \label{j0218}
          Our ROI is a circle with radius of $20^\circ$ and all parameters of sources which are $8^\circ$ outside 
          of the center are fixed. For sources within $8^\circ$, initial values of parameters are the same as
          their default values.
          In our case, there are 7 point sources which have free parameters. In the Fig.
          \ref{fig: j0218_count_map_and_model}, the green circles represent those free sources. We need to notice 
          that in the outer parts of the count map, there are some of very 
          bright sources which have no free parameters. The reason is that the they are so far away from our target source
          that the Fermi telescope can distinguish if a photon comes from the target source or the outer sources.
          As a result, we do not need to fit any parameters for those outer sources. 
          However, it is another case for the nearby sources and we have to fit parameters of them.
          
          \subsubsection{Count Maps And Count Cubes}
          \begin{figure}[!ht]  
            \begin{center}
            \begin{minipage}{0.45\textwidth}
              \begin{center} 
                  \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/j0218_count_map_with_region.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.45\textwidth}
              \begin{center} 
                  \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/j0218_count_map_model.png}
              \end{center}
            \end{minipage}
          \end{center}
            \begin{center}
              \mycaption{The count map of PSR J0218+4232 (left) and the count map generated by the model (right). 
              In the left figure,
              the green circles represent free sources. The figure in the right is a count map created 
              according to our fitted spectra model. 
              The size of each figure is 141 pixels $\times$ 141 pixels, and the dimention for 
              each pixel is $0.2^\circ \times 0.2^\circ$.}
            \label{fig: j0218_count_map_and_model}    
            \end{center} 
          \end{figure}
          In the left of the Fig.\ref{fig: j0218_count_map_and_model} 
          is the count map of PSR J0218+4232.
          In the center of the left figure, 
          we can clearly see our target source. The dimension of the Fig.s seems to be weird and 
          the reason why we have 141 pixels for both x and y axis is that we select a circle region from 
          the original data. However, when we generate a count map, we have to assign the sizes for x and y 
          axis separately, which means that our a count map is actually rectangular. As a result, we have to crop a 
          rectangular from the original circle region and in this case, we choose the rectangular as a square.  
          
          \begin{figure}[!ht]
            \begin{minipage}{0.32\textwidth}
              \begin{center} 
                \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j0218_ccube_start.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.32\textwidth}
              \begin{center}
                \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j0218_ccube_middle.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.32\textwidth}
              \begin{center}
              \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j0218_ccube_end.png}
              \end{center}
            \end{minipage}
            \mycaption{Three count maps from PSR J0218+4232's count cube. The energy ranges of the figures are 
              100$\sim$123MeV, 1.873$\sim$2.310GeV, 35.11$\sim$43.29GeV respectively.}
            \label{fig: j0218_ccube_bin_1_and_15}
          \end{figure}
          
          The Fig.\ref{fig: j0218_ccube_bin_1_and_15} is a comparison between PSR J0218+4232's count maps in different energy 
          bands. The count map in about 100MeV is so messy that we can hardly distinguish our target source 
          while above 30GeV there are so few photons that there is not a clear sign of the source. 
          We choose three circle regions whose centers are the our target sources and the radii are 1000 $''$ for 
          all of the three figures and then calculate the total numbers of photon counts of the selected regions. 
          As the following table \ref{table:j0218_ccube_photon_counts}
          shown, though total number of photon counts around our target source is similar between the left and middle
          count maps, the 
          numbers of counts per energy are much different. Since there are few photons in high energy bands 
          (above 50 $GeV$) compare to other energy bands, we focus more on the lower energy part. 

          \begin{table}[!h]   
            \centering
            \begin{tabular}{|m{4.5cm} | c | c | c |}
              \hline 
              & Left & Middle & Right \\
              \hline
              Total counts & 78 & 93 & 0 \\
              \hline 
              Energy range ($MeV$) & 100$\sim$123 & 1873$\sim$2310 & 35110$\sim$43290 \\ 
              \hline
              Counts / MeV ($MeV^{-1}$)& 3.39 & 0.213 & 0.000 \\  
              \hline
            \end{tabular}
            \mycaption{Numbers of photon counts of count maps in different energy bands for PSR J0218+4232.}
            \label{table:j0218_ccube_photon_counts}
          \end{table}
          \subsubsection{Spectra Fitting}
            The Fig.\ref{fig: j0218_count_map_and_model} shows that the fit result of the model 
            is similar to the observation. However, 
            there are lots of small red pixels in the left figure (generated directly by the observation data) while the 
            right figure is very "clean". This means that a lot of photons are thought as generated by the modeled 
            source. Thus in our model, the sources are generally slightly brighter than the observation. However, our target
            source is an exception. In the region we have used before (the center is the target source, and the radius is
            1000$''$), the total photon count in the left figure is 1815 compare to 1737 in the right figure. 

            The reason why the count map generated directly by the observation data is a lot more messy is that our source 
            model is generated according to the Fermi database and their spatial position is fixed. This means that if 
            a photon comes from a particular direction and there is no any known pulsar in that direction, this 
            photon has to be classified to other directions and there is a modeled source in the direction.  
            Thus, the spatial positions of photons are different between the observation and the model and 
            the count maps generated directly from models are usually cleaner. 
            
            % \begin{figure}[!ht]
            %   \begin{minipage}{1\textwidth}
            %     \begin{center} 
            %       \includegraphics[scale=0.6]{/Users/grewwc/Desktop/Thesis/j0218_count_map_diff.png}
            %     \end{center}
            %   \end{minipage}
            %   \centering
            %   \begin{minipage}{0.8\textwidth}
            %     \mycaption{The residual map shows the difference between the observation and the model. 
            %     It is generated by subtracting the photon counts of each pixel between the count maps of 
            %     observation and the model. 
            %     \change{ugly, scale may be wrong}}
            %     \label{fig: j0218_count_map_diff}
            %   \end{minipage}
            % \end{figure}

            \begin{figure}[!ht]
              \begin{center}
              \begin{minipage}{0.45\textwidth}
                \begin{center} 
                  \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/j0218_count_map_linear_scale.png}
                \end{center}
              \end{minipage}
              \begin{minipage}{0.45\textwidth}
                \begin{center}
                  \includegraphics[scale=0.4]{/Users/grewwc/Desktop/Thesis/j0218_dif_map_linear_scale.png}
                \end{center}
              \end{minipage}
            \end{center}
            \mycaption{The count map and residual map of PSR J0218+4232.
              The figures are both in linear scale in order to compare the residual map between the 
              original count map more intuitively. The left figure is the count map and the right 
              one is the residual map which shows the differences between the observation and the spectral 
              model. It is created by directly subtracting the photon counts of each pixel between 
              the count maps of observation data and the spectral model. The green circle regions represent
              (the regions are completely the same in the two figures)
              the largest number photon counts of the residual map and its radius is $2000''$.}
            \label{fig: j0218_count_map_diff}
            \end{figure}

            The Fig.\ref{fig: j0218_count_map_diff} basically describes how well our model is compared to the 
            observation data. There are some black dots and bright dots in the residual map showing 
            the differences between our spectral model and the observation data. In the residual map of Fig.
            \ref{fig: j0218_count_map_diff}, most differences of absolute photon counts are small, however,
            in the green circle region, the absolute value is large whose value is 6003. This means that in this region,
            the number of photon counts of the observation data (21525) is 6003 larger than in our model.  
            This is not negligible since it is nearly $28\%$ of the original photon counts. 
            Does this mean that our model is not good? The answer should be yes, however, this does 
            not mean our fit is not good since the model parameters in this region are all fixed and the 
            fixed values are from the Fermi LAT 4-year Point Source Catalog. Hence, the difference 
            shows some problems of our spectral model, but has nothing to do with the fit result. 
            Instead, from the residual map, we can see that the fit result is good because the differences
            of number of photon counts are very low, which are about $5\%$ of the photon 
            counts of the count map on average.

            The table \ref{table: j0218_fit_result} lists the results of the fitting parameters. 
            We see from the table \ref{table: j0218_fit_result} that the new fit results are consistent 
            with the old results. However, the precision improves a lot which is ascribed to the 
            Fermi LAT Third Source Catalogue and PASS 8 data. The Fig.
            \ref{fig: j0218_cur_with_data_points.png} is a plot of the spectrum according to 
            the function \ref{eq: fermi_model}.
            One thing should be noticed is that we need to multiply $E^2$ to the function \ref{eq: fermi_model} 
            in order to get the flux. The Fig.\ref{fig: j0218_cur_with_data_points.png} shows that the global 
            fit is consistent with flux points fitted by each energy bin separately. 
            The TS value of our target source is 7110, which gives us 
            a significance level $\sigma \approx \sqrt{TS} = 84$. This strongly implies the presence of our
            target source. We can also use a TS map to test the presence of the source as the Fig.
            \ref{fig: j0218_tsmap_comparison_15} and \ref{fig: j0218_tsmap_comparison_20} shown. 
            There are 2 sets of Ts maps with different scales. The first group is $3^{\circ} 
            \times3^{\circ}$ while the second group is $2^{\circ} \times2^{\circ}$. 
            \vspace{1cm}
            \begin{table}[!ht]
              \centering
                \begin{tabular}{|c|c|c|c|c|}
                  \cline{1-5}
                  & \multicolumn{2}{|c|}{Now} & \multicolumn{2}{|c|}{Previous} \\
                  \cline{1-5}
                  & Value & Error & Value & Error \\
                  \hline
                  Index1 ($\gamma_1$) & $1.89492$ & $0.04044$ & $2.0$ & $0.1$ \\
                  \hline 
                  Cutoff ($E_c$, MeV) & $3766.69$ & $397.38$ & $4600$ & $1200$ \\
                  \hline 
                  Photon Flux (ph $cm^{-2} s^{-1}$) ($10^{-8}$) & $7.28913$ & $0.27988$ & $7.7$ & $0.7$ \\ 
                  \hline
                \end{tabular}    
                \mycaption{Fit parameters of the spectral model of PSR J0218+4232. 
                  The names of parameters are consistent with the equation
                  \ref{eq: fermi_model}. The old results are from the paper \cite{0067-0049-208-2-17}.
                  \\
                  \change{should rename "Previous" and "Now". \\ 
                      should draw a diagnal line in the upper left cell, but don't know how yet.)}}
                \label{table: j0218_fit_result}        
            \end{table}  

            \singleFig{j0218_cur_with_data_points.png}{0.6}{
              The log-log plot of flux to energy of PSR J0218+4232. The grey shade represents 
              fitting errors, black points with error bars are flux points, the blue dots are upper values and the 
              red line is the PLExpCutoff model multiplied by $E^2$. Flux points 
              are fitted separately by dividing the total energy bin (100 MeV $\sim$ 100 GeV) into multiple energy bins.
              The horizontal error bars represents the width of each bin. \\
              (The figure should use legends, but for now I have problem setting those styles, 
              may be my matplotlib version is too old.) \\
              \change{legends, arrows}
            }
            \vspace{1cm}
            % \singleFig{blank.png}{0.3}{\change{The Fig.should be a TS map, but the new TS map has not been generated yet.
            % The previous TS map does not use the best fit parameters, so I have to re-generate the TS map. And this 
            % world map is just a reminder and it may be used a lot.}}
            \begin{figure}[!ht]
              \begin{center}
              \begin{minipage}{0.46\textwidth}
                \begin{center} 
                  \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/j0218_with_source_15.png}
                \end{center}
              \end{minipage}
              \begin{minipage}{0.45\textwidth}
                \begin{center}
                  \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/j0218_nosource_15.png}
                \end{center}
              \end{minipage}
            \end{center}
            \mycaption{TS maps of PSR J0218+4232. The figures' dimensions are 
            $3^{\circ} \times3^{\circ}$ ($15 pixels \times 15 pixels$ with 
            $0.25^{\circ} \times 0.25^{\circ}$ for each pixel). The \textsf{left}
            figure and \textsf{right} figure are generated by the XML models with and without our 
            target source PSR J0218+4232 respectively. The \textsf{left} figure shows that the 
            possibility of adding an imputative point source is very low only with a maximum TS value of 
            less than 5. However, the \textsf{right} figure strongly implies that there should be an 
            additional source after we have removed our target source from the spectral model, 
            which means it's highly likely that PSR J0218+4232 is contained in our observation data.}
            \label{fig: j0218_tsmap_comparison_15}
            \end{figure}

            \begin{figure}[!ht]
              \begin{center}
              \begin{minipage}{0.45\textwidth}
                \begin{center} 
                  \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/j0218_tsmap_with_source_20.png}
                \end{center}
              \end{minipage}
              \begin{minipage}{0.45\textwidth}
                \begin{center}
                  \includegraphics[scale=0.45]{/Users/grewwc/Desktop/Thesis/j0218_nosource_20.png}
                \end{center}
              \end{minipage}
            \end{center}
              \mycaption{TS maps for PSR J0218+4232. The figures' dimensions are 
              $4^{\circ} \times4^{\circ}$ ($20 pixels \times 20 pixels$ with 
              $0.25^{\circ} \times 0.25^{\circ}$ for each pixel). The figures' meanings 
              are completely the same with the Fig.\ref{fig: j0218_tsmap_comparison_15}}
              \label{fig: j0218_tsmap_comparison_20}
            \end{figure}
            % After obtaining the spectra fit results in gamma-ray band, we can generate a broad band spectrum. 
            % The hard X-ray data is from the paper  
            % \blackhref{https://arxiv.org/pdf/1704.02964.pdf}{NUSTAR HARD X-RAY OBSERVATIONS OF THE ENERGETIC   %
            % MILLISECOND PULSARS PSR B1821-24, PSR B1937+21, AND PSR J0218+4232}. We also generate simulation data
            % from the two-layer model. Then we compare the simulation and observation as the Fig 
            % \ref{fig: J0218+4232} shown. The prediction of the two-layer model is consistent with the observation
            % both in X-ray band (from about 3 keV to 10 MeV) and high energy gamma-ray band (above 1 GeV). However, 
            % from about 100 MeV to 1 GeV, the spectrum from the two-layer model is not consistent with Fermi data. 
            % This can have 2 explanations. Firstly, the Fermi telescope is not sensitive in about 100 MeV.
            % As a result, the observatoin data may not be very reliable at about this energy band. Secondly, the  
            % real emission mechanism in the energy band is different from the model predicts. Thus, we can observe 
            % inconsistency between the simulation and observation.

            % \singleFig{J0218+4232}{0.35}{\Notice{have to uniformly change the style of figures later.}}

            \subsection{PSR B1821-24}
              The ROI region is a circle whose radius is $20^\circ$ and all 
              parameters of sources outside of $8^\circ$ are fixed. 
              There are 6 free sources in the region of $8^\circ$. The Fig.
              \ref{fig: b1821_count_map_with_region_and_model} 
              is a combination of count maps of observation data and the model. 

              \subsubsection{Count Maps And Count Cubes}
                \begin{figure}[!ht]
                  \begin{center}
                  \begin{minipage}{0.45\textwidth}
                    \begin{center} 
                      \includegraphics[scale=0.31]{/Users/grewwc/Desktop/Thesis/b1821_count_map_with_region.png}
                    \end{center}
                  \end{minipage}
                  \begin{minipage}{0.45\textwidth}
                    \begin{center}
                      \includegraphics[scale=0.37]{/Users/grewwc/Desktop/Thesis/b1821_count_map_model.png}
                    \end{center}
                  \end{minipage}
                \end{center}
                \mycaption{The count map of PSR B1821-24 (left) and the count map generated by the 
                model (right). In the left figure, the green circles are free sources. The sizes of the both 
                figures are 141 pixels $\times$ 141 pixels, and each pixel's dimension is 
                $0.2^\circ \times 0.2^\circ$.}
                \label{fig: b1821_count_map_with_region_and_model}
              \end{figure}
            
              \begin{figure}[!ht]
                \begin{center}
                \begin{minipage}{0.32\textwidth}
                  \begin{center} 
                    \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/b1821_ccube_start.png}
                  \end{center}
                \end{minipage}
                \begin{minipage}{0.32\textwidth}
                  \begin{center}
                    \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/b1821_ccube_15.png}
                  \end{center}
                \end{minipage}
                \begin{minipage}{0.32\textwidth}
                  \begin{center}
                  \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/b1821_ccube_end.png}
                  \end{center}
                \end{minipage}
              \end{center}
              \mycaption{Three figures of PSR B1821-24's count cube. The energy ranges of the figures are  
                100$\sim$123MeV, 1.873$\sim$2.310GeV, 81.11$\sim$100GeV respectively from left to right.}
              \label{fig: b1821_ccube_1_15_33.png}
              \end{figure}

              The left and right part of the Fig.\ref{fig: b1821_count_map_diff.png} is the count 
              map of the PSR B1821-24 generated from observation data and spectral model respectively. 
              Like the situations of PSR J0218+4232, the count map from the model is clearly cleaner than 
              from the observation data and the two figures are very similar, which implies that our model 
              is close to the observation data. 

              The Fig.\ref{fig: b1821_ccube_1_15_33.png} are count maps of PSR B1821-24 in different energy 
              bands. The target pulsar is too faint in very high energy bands and interfered too much by the ambient 
              environment in low energy bands (around 100MeV). Because our target source is near the M28 globular 
              cluster and very faint, it is reasonable that the fitting result is not as good as PSR J0218+4232. 
              \subsubsection{Binned Likelihood Analysis}
              \begin{figure}[!ht]
                \begin{center}
                \begin{minipage}{0.45\textwidth}
                  \begin{center} 
                    \includegraphics[scale=0.40]{/Users/grewwc/Desktop/Thesis/b1821_count_map_linear_scale.png}
                  \end{center}
                \end{minipage}
                \begin{minipage}{0.45\textwidth}
                  \begin{center}
                    \includegraphics[scale=0.40]{/Users/grewwc/Desktop/Thesis/b1821_count_map_diff.png}
                  \end{center}
                \end{minipage}
              \end{center}
              \mycaption{The count map and residual map of PSR B1821-24 in linear scale. 
              The \textsf{left} figure is the count map and the \textsf{right} 
              figure is the residual map showing the difference between the observation data and the spectral model.}
              \label{fig: b1821_count_map_diff.png}
            \end{figure}

            \singleFig{b1821_spectrum_with_points.png}{0.6}{The log-log plot of flux to energy of 
              PSR B1821-24's gamma-ray spectrum. 
              \change{should use legends, add arrows for upper values, make the label fonts larger.}}
              \vspace{1cm}

            The differences of the count map between the observation data and the model are described as the Fig.
            \ref{fig: b1821_count_map_diff.png} which are both in linear scale. In the right part of the figure, 
            there are some black dots 
            with absolute values about $-800$. Though their values are relatively high, the number of 
            high-value dots are very small so the fit is acceptable in general. 

            The table \ref{table: b1821_fit_result} shows the global fit results of PSR B1821-24. 
            \mayChange{There is no previous fit results for the pulsar, so we cannot compare our result
            with the old one.} The TS value of the model is 941 which gives us a significance level 
            of about $\sqrt{941} \sim 31$. This strongly supports the existence of the target source in 
            the observation data.

            The Fig.\ref{fig: b1821_spectrum_with_points.png} shows that the global fit is consistent with 
            the flux points generated by fitting sub-energy bins separately. However, 
            we should notice the first flux point 
            which is denoted as a blue square in the Fig.\ref{fig: b1821_spectrum_with_points.png}. This 
            flux point is significantly smaller than the global fit (the red line in the figure). 
            In addition, the upper value for the first energy bin is still slightly smaller than the global fit. 
            Though it is strange that the upper value is smaller than the normal value at first glance, 
            it is reasonable since the flux points are fitted separately and are independent to 
            the global fit. In fact, we use a single power-lay model to fit each sub-energy bin while PLExpCutoff
            model to do the global fit. As we have explained previously, the lower energy parts of the 
            observation (around 100 MeV) is not as reliable as other energy bands. As a result, the separate 
            fit for the first energy bin
            is not as reliable as the global fit and it is reasonable that the two fit results are not completely
            consistent. When this happening, we have more confidence on the global fit than the separate fit.
            
            \begin{table}[!ht]
              \centering
                \begin{tabular}{|c|c|c|c|c|}
                  \cline{1-5}
                  & \multicolumn{2}{|c|}{Now} & \multicolumn{2}{|c|}{Previous} \\
                  \cline{1-5}
                  & Value & Error & Value & Error \\
                  \hline
                  Index1 ($\gamma_1$) & $1.906$ & $0.068$ & $Nan$ & $Nan$ \\
                  \hline 
                  Cutoff ($E_c$, MeV) & $4501.92$ & $710.41$ & $Nan$ & $Nan$ \\
                  \hline 
                  Photon Flux (ph $cm^{-2} s^{-1}$) ($10^{-8}$) & $3.85$ & $0.31$ & $Nan$ & $Nan$ \\ 
                  \hline
                \end{tabular}    
                \mycaption{Fit parameters of the spectral model of PSR B1821-24. 
                  The names of parameters are also onsistent with the equation
                  \ref{eq: fermi_model}. \question{The old results are not available yet} \\
                  \change{should rename "Previous" and "Now". \\ 
                      should draw a diagnal line in the upper left cell, but don't know how yet.)}}
                \label{table: b1821_fit_result}        
            \end{table}  
            \vspace{1cm}
              % \singleFig{blank.png}{0.3}{\change{The Fig.should be a TS map, but the new TS map has not been generated yet.
              % The previous TS map does not use the best fit parameters, so I have to re-generate the TS map. And this 
              % world map is just a reminder and it may be used a lot.}}

            \begin{figure}[!ht]
              \begin{center}
              \begin{minipage}{0.46\textwidth}
                \begin{center} 
                  \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/b1821_tsmap_with_source_15.png}
                \end{center}
              \end{minipage}
              \begin{minipage}{0.45\textwidth}
                \begin{center}
                  \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/b1821_tsmap_nosource_15.png}
                \end{center}
              \end{minipage}
            \end{center}
            \mycaption{TS maps of PSR B1821-24. The figures' dimensions are $3^{\circ} \times3^{\circ}$ 
            ($15 pixels \times 15 pixels$ with $0.25^{\circ} \times 0.25^{\circ}$ for each pixel). 
            The \textsf{left} figure and \textsf{right} figure are generated by the XML models with and without our 
            target source PSR B1821-24 respectively. The \textsf{left} figure shows that the possibility 
            of adding an imputative point source is very low only with a maximum TS value of 
            less than 11 while the TS values of the \textsf{right} figure are generally much larger.}
            \label{fig: b1821_tsmap_comparison_15}
            \end{figure}
            \vspace{1cm}

            \begin{figure}[!ht]
              \begin{center}
              \begin{minipage}{0.45\textwidth}
                \begin{center} 
                  \includegraphics[scale=0.43]{/Users/grewwc/Desktop/Thesis/b1821_tsmap_with_source_20.png}
                \end{center}
              \end{minipage}
              \begin{minipage}{0.45\textwidth}
                \begin{center}
                  \includegraphics[scale=0.37]{/Users/grewwc/Desktop/Thesis/b1821_tsmap_nosource_20.png}
                \end{center}
              \end{minipage}
            \end{center}
            \mycaption{TS maps of PSR B1821-24. The figures' dimensions are $4^{\circ} \times4^{\circ}$ 
            ($20 pixels \times 20 pixels$ with $0.25^{\circ} \times 0.25^{\circ}$ for each pixel). 
            The meaning of the figure is the same as the Fig.\ref{fig: b1821_tsmap_comparison_15}}
            \label{fig: b1821_tsmap_comparison_15}
            \end{figure}
            \vspace{1cm}
      
        \subsection{PSR B1937+21}
          In order to make the data analysis be more consistent, we choose the same parameters
          to process the raw observation data. Like the other two MSPs, the radius of ROI is $20^{\circ}$ 
          degrees, and all parameters of sources $8^{\circ}$ degrees outside from the center 
          are fixed with default values. The Fig.\ref{fig: j1939_count_map} is the 
          comparison of count maps between observation data and the spectral model. 
          \subsubsection{Count Maps and Count Cubes}
          \begin{figure}[!ht]
            \begin{center}
            \begin{minipage}{0.45\textwidth}
              \begin{center} 
                \includegraphics[scale=0.38]{/Users/grewwc/Desktop/Thesis/j1939_count_map.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.45\textwidth}
              \begin{center}
                \includegraphics[scale=0.38]{/Users/grewwc/Desktop/Thesis/j1939_count_map_model.png}
              \end{center}
            \end{minipage}
          \end{center}
          \mycaption{The count maps of PSR B1937+21 are created from observation 
            data (\textsf{left}) and from the spectral model (\textsf{right}) respectively. 
            The dimensions of both figures are $141 pixels \times 141 pixels$ and each pixel is 
            $0.2^{\circ}\times0.2^{\circ}$ large.}
            \label{fig: j1939_count_map}
          \end{figure}
          \vspace{1cm}

          There are 4 point sources with free parameters in the model which are represented by the green 
          circles in the Fig.\ref{fig: j1939_count_map}.
          However, the left part of the Fig.\ref{fig: j1939_count_map} only contains three circles.
          This is the difference between the PSR B1937+21 and the the other two MSPs discussed 
          above. With some reasons, the PSR B1937+21 is not shown in Fermi LAT Third Source Catalogue.
          Therefore, in order to analysis the spectrum of this MSP, we have to add the source 
          by hand. The green circles are only created by Fermi tools by default, hence our source is 
          not represented by a green circle. In addition, the count map is so messy that we completely 
          cannot distinguish the source PSR B1937+21 from the count map. 
          Since our target pulsar PSR B1937+21 is not in the Fermi LAT Third Source Catalogue and 
          we have to generate the model by hand, we need to set the model with its parameters properly.
          Like the other 2 MSPs, we choose the specified PLSuperExpCutoff model and set the initial value 
          of photon index to be $-2.5$.

          The Fig.\ref{fig: j1939_count_cube} shows count maps in difference energy bands. As 
          the figure shown, the lower energy band is very messy while there is nearly nothing 
          valuable in the high energy band. Therefore, when we divide the total energy bin into 
          sub-bins to do analysis separately, we focus on the middle parts and have more bins
          in that range of energy.

          \add{Continue from here... \\
            PSR B1937+21 is a little bit different. I did a phase resolved analysis, 
            in order to show if it is necessary, I plan to do a new phase averaged analysis for 
            comparison. The best phase averaged results are not finished completely yet, but soon.}
          \begin{figure}[!ht]
            \begin{minipage}{0.32\textwidth}
              \begin{center} 
                \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j1939_ccube_start.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.32\textwidth}
              \begin{center}
                \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j1939_ccube_middle.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.32\textwidth}
              \begin{center}
              \includegraphics[scale=0.25]{/Users/grewwc/Desktop/Thesis/j1939_ccube_end.png}
              \end{center}
            \end{minipage}
            \mycaption{Three figures of PSR B1937+21's count cube. The energy ranges of the figures 
            are 100$\sim$123MeV, 1.873$\sim$2.310GeV, 35.11$\sim$43.29GeV respectively.}
            \label{fig: j1939_count_cube}
          \end{figure}
          \vspace{0.5cm}

        \subsubsection{Binned Likelihood Analysis}
          The Fig.\ref{fig: j1939_count_map_diff} is the residual map together with the 
          original count map in linear scale.
          \begin{figure}[!ht]
            \begin{center}
            \begin{minipage}{0.45\textwidth}
              \begin{center} 
                \includegraphics[scale=0.34]{/Users/grewwc/Desktop/Thesis/j1939_count_map_linear.png}
              \end{center}
            \end{minipage}
            \begin{minipage}{0.45\textwidth}
              \begin{center}
                \includegraphics[scale=0.35]{/Users/grewwc/Desktop/Thesis/j1939_count_map_model_linear.png}
              \end{center}
            \end{minipage}
          \end{center}
          \mycaption{The count maps of PSR B1937+21 created from observation 
          data (\textsf{left}) and from the spectral model (\textsf{right}). The dimensions
          of both figures are $141 pixels \times 141 pixels$ and each pixel's size is
          $0.2^{\circ}\times0.2^{\circ}$.}
          \label{fig: j1939_count_map_diff}
        \end{figure}
        \vspace{1cm}

    \chapter{Theory And Simulation}
      \section{Two-layer Model}
      After we have reviewed gamma-ray fundamental emission mechanism, we can proceed to
      the Two-layer model on which this thesis is mainly based. Two-layer model is a 
      variation of outer-gap model since they both claim that the gamma-ray emission zone
      is close to the light-cylinder. However, in two-layer model, the outer layer 
      consists of two regions --- a primary acceleration region and a screening region. 

      In the primary region, charged particles moved out of pulsars along the open field lines, 
      so the charge density is usually very low. 
      However, by pair-production processes, a lot of $e^{-}$ and $e^{+}$ are produced. 
      But in the primary region where lots of pairs are created, the charge density doesn't 
      change very much because the pairs have not been separated yet. With the help of strong 
      electric field, the particles of different signs move to opposite directions. 
      As a result, the two-layer model states that just above the primary region, a screening 
      region will be created and the charge density is very large. This is basically the reason why 
      there are two regions in pulsars' outer magnetosphere.

      Then the next issue is that how we describe the distribution of charge density in these two regions. 
      For simplicity, we just use a step function to represent the charge density distribution and step function 
      can clearly shows the gap between the two regions. We use a magnetic dipole model to approximate the 
      magnetic distribution in the magnetosphere. Since in magnetic dipole model, magnetic field at one position is 
      only dependent on the position's distance from the source and altitude, we can also ignore the azimuthal 
      distribution of charge density in our model and use the two parameters
      the $r (distance)$ and $\theta (altitude)$ to calculate the magnetic field at some position.

      In the two-layer model, we can use three parameters to express the structure of a pulsar's outer 
      magnetosphere - charge density of the primary region, the total length of the primary region and the 
      screening region and the last one is the ratio of the thickness of the primary region and the 
      screening region. The Fig.\ref{fig: charge_density} shows the basic structure of two-layer model. 

      \singleFig{charge_density}{0.6}{(a): The geometry of two-layer model. $h_{1}$ and $h_{2}$ is the height
      of the primary region and the screening region respectively. (b): the charge densities of primary region and 
      screening region. In the primary region, the charge density is much smaller than Goldreich-Julian charge density
      while is larger in the screening region. \mayChange{this figure is from the previous paper, I may need to 
      regenerate the Fig..}}

      As the Fig.\ref{fig: charge_density} showing, 
      let the charge density of the primary region be $\rho_1 = (1-g_{1}) \rho_{GJ}$ and the total gap size is 
      $h_{2}$, where $\rho_{GJ}$ is Goldreich-Julian charge density. For convenience, 
      we also denote the gap size of the primary region as $h_{1}$. 
      \myComment{Then we can calculate electric potential and electric field by solving the Poisson equation }

      We denote the electrical potential to be $\phi_{0}$ which satisfies 
      \begin{equation}
        \label{eq: Poisson_corotating}
        \nabla^{2}\phi_{0} = -4\pi\rho_{GJ}
      \end{equation}
      and the total electrical potential is $\phi = \phi_{0} + \phi^{\prime}$, where $\phi^{\prime}$ is a 
      representation of the deviation of the co-rotating electrical potential.  
      Let total charge density is $\rho$ and subtract the equation \ref{eq: Poisson_corotating} we have 
      \begin{equation}
        \label{eq: Poisson_final}
        \nabla^{2}\phi^{\prime} = -4\pi\left(\rho - \rho_{GJ} \right)
      \end{equation}

      Because the model has ignored the distribution in the azimuthal direction, we can use two parameters 
      $x, z$ to represent a position, where $x$ is the direction along the magnetic field line and $z$ is the 
      perpendicular to the magnetic field line. In order to solve the equation \ref{eq: Poisson_final}, 
      the model also makes 2 approximations. The first is that the directive of electrical potential $\phi$ 
      is ignored. The second is that the \gj{} is uniformly distributed along the magnetic line direction 
      ($x$ direction). These 2 approximations are based on the a reasonable assumption that the change rate 
      for both electrical potential ($\phi^{\prime}$) and \gj{}($\rho_{GJ}$) along the $x$ direction is much 
      smaller compared with $z$ direction. 
      As a result, the equation \ref{eq: Poisson_final} can be written as: 
      \begin{equation}
        \label{eq: Poisson_final_final}
        \frac{\partial^2}{\partial z^2} \phi^{\prime} = -4\pi\left(\rho - \rho_{GJ} \right)
      \end{equation}

      In order to solve the equation \ref{eq: Poisson_final_final}, we have to have proper boundary conditions. 
      First of all, we have to decide the boundary positions, which is determined by 4 parameters and they are  
      $x_{lo}, x_{hi}, z_{lo}, z_{hi}$. It is reasonable to set $x_{lo}$ and $x_{hi}$
      be the pulsar's surface and the light cylinder respectively and $z_{lo}$ (lower boundary) be the last open 
      field line. And let the electrical potential be $0$ along the last open field line (this is because we have 
      ignored the variation of electric field in $x$ direction).   

      \begin{equation}
        \label{eq: lower_boundary}
        \phi \left(x, z_{lo}\right) = 0
      \end{equation}
      The position of $z_{hi}$ is a little bit tricky. In order to make the electrical potential be 
      continuous at $z = z_{hi} = h_2$, the model sets the $\phi^{\prime}\left(z=h_{2}\right) = 0$ since the 
      non-corotating electrical potential outside the upper bound is $0$ and the co-rotating potential
      is continuous near the boundary. Additionally, because $\phi^{\prime}\left(z=h_{2}-\right) = 0$
      and $\phi^{\prime}\left(z=h_{2}+\right) = 0$, we know that the first order derivative 
      $\partial{\phi^{\prime}}/\partial{z}\vert_{z=h_{2}}$ is $0$, which means 
      $E_{\perp}\vert_{z=h_{2}} = 0$. 
      In order to solve the equation \ref{eq: Poisson_final_final}, we denote charge densities of
      the two regions for convenience as the following function 
      \ref{eq: twolayer_charge_density} shown.
      \begin{equation}
        \label{eq: twolayer_charge_density}
          \rho\left(z\right) = 
          \begin{cases}
             & \rho_{1} , \text{    if} \left(0 \leq z < h_{1}\right)\\
             & \rho_{2} , \text{    if} \left(h_{1} \leq z \leq h_{2}\right) 
          \end{cases}       
      \end{equation}
      With the definition \ref{eq: twolayer_charge_density} and the three boundary conditions
      we can directly solve the equation \ref{eq: Poisson_final_final} and the result is:
      \begin{equation}
        \label{eq: twolayer_potential}
          \phi^{\prime}\left(z, x\right) = -2\pi
          \left\{\begin{alignedat}{2}
             & \left(\rho_{1} - \rho_{GJ}\left(x\right)\right)z^2 + C_{1} z ,  &&\left(0 \leq z < h_{1}\right)\\
             & \left(\rho_{2}-\rho_{GJ}\left(x\right)\right)\left(z^2 - h_2^2\right) + D_{1} \left(z-h_2\right),  &&\qquad \left(h_{1} \leq z \leq h_{2}\right) 
          \end{alignedat}\right.
      \end{equation}
      where 
      \begin{align*}
        C_{1} &= \frac{\left(\rho_{1}-\rho_{GJ}\left(x\right)\right)h_1\left(h_1-2h_2\right)-\left(\rho_2-\rho_{GJ}\left(x\right)\right)\left(h_1-h_2\right)^2}{h_2} \\
        D_{2} &= \frac{\left(\rho_1-\rho_2\right)h_1^2-\left(\rho_2-\rho_{GJ}\left(x\right)\right)h_2^2}{h_2}
      \end{align*}
      From equation \ref{eq: twolayer_potential} and apply $\rho_{GJ}\left(x\right)=-\left(\Omega B x\right)/\left(2\pi cs\right)$ 
      we can directly derive the electrical field parallel to magnetic field lines as a function of $z$
      as the equation \ref{eq: twolayer_field} shown.
      \begin{equation}
        \label{eq: twolayer_field}
          E^{\prime}_{\parallel}\left(z\right) = \frac{\Omega B}{cs}
          \left\{\begin{alignedat}{2}
             & -g_1 z^2 + C_1^{\prime}z ,  &&\left(0 \leq z < h_{1}\right)\\
             & g_2\left(z^2 - h_2^2\right) + D_1^{\prime}\left(z-h_2\right)  &&\qquad \left(h_{1} \leq z \leq h_{2}\right) 
          \end{alignedat}\right.
      \end{equation}
      where 
      \begin{align*}
        C_{1}^{\prime} &= \frac{g_1 h_1 \left(h_1 - 2h_2\right)+ g_2\left(h_1-h_2\right)^2}{h_2} \\
        D_{2}^{\prime} &= -\frac{\left(g_1 + g_2\right)h_2^2 + g_2 h_2^2}{h_2}
      \end{align*}

      Since charged particles are accelerated in the primary region to relativistic speed 
      and then emit energy by curvature radiation, we have equation \ref{eq: all_is_curvature_radiation}.
      \begin{equation}
        \label{eq: all_is_curvature_radiation}
        e E_{\parallel}^{\prime} c = l_{cur}
      \end{equation}
      where $E_\parallel^{\prime}$ is the electric field strength along the magnetic field line 
      described in equation \ref{eq: twolayer_field}.
      We can estimate Lorentz factors of the charged particles according to the function 
      \ref{eq: curvature_radiation_power}.
      \begin{equation}
        \label{eq: curvature_radiation_power}
        l_{cur} = \frac{2 e^2 c \gamma^{4}_{e}}{3s^2}
      \end{equation}      
      where $s$ is the radius of curvature. 
      Combining the equation \ref{eq: all_is_curvature_radiation} and 
      \ref{eq: curvature_radiation_power} we get Lorentz factor: 
      \begin{equation}
        \label{eq: gamma_can_be_zero}
        \gamma_{e} = \left(\frac{3s^2}{2e} E_{\parallel}^{\prime}\right)^{1/4}
      \end{equation}
      With Lorentz factor of charged particles known, we can derive curvature radiation spectrum
      for single charged particle and then can get the total spectrum by integrating over all 
      charged particles. This is the simplified basic idea of the Two-layer model. 

      \subsubsection{Constraints of The Two-lay Model Used In The Thesis} 
        The simplified two-layer model is consistent with observation data to some extent. 
        (The relevant data can be found in the paper \cite{0004-637X-720-1-178})
        The model uses 4 parameters to get a fair good prediction of gamma-ray spectra for many 
        pulsars. And all these 4 parameters have a very obvious physical meaning. 
        However, we can clearly find the "defects" of the model --- it is somewhat oversimplified. 
        Though there are other more sophisticated version of two-layer model, we use the simpler one, 
        which may cause some inconsistency between our simulation and observation. 

        Therefore, we can briefly analyze which part is oversimplified and can be improved. 
        First of all, we directly use a step function to describe the charged particle distribution. 
        Though the charge density of the screening region is much larger than the primary region, using 
        a step function is non-physical and may exaggerate the change rate of charge density. At the 
        same time, the dramatic change of charge density also brings introduces some instability for 
        numerical simulation. 

        Secondly, the model sets the total of screening region and primary region to be rectangular shape. 
        Though the shape is not clear, it should not be a rectangular in theory and may be very different.
        In numerical simulation, changes in shape of the regions will directly lead to a different 
        integration region, which may change the simulated spectra completely.

        Thirdly, there are some inconsistency in the model itself according to the its assumption. 
        According to the equations \ref{eq: curvature_radiation_power} and \ref{eq: gamma_can_be_zero}
        since $E_{\parallel}^{\prime}$ can be $0$, we know that 
        $\gamma_{e}$ can also be $0$, which is absolutely impossible. Although this may not have a big 
        influence on the spectra, it is the problem that we should solve. 

        All in all, the model is simple and the gamma-ray spectra computed based on the model is 
        consistent with observation data. There are many much more sophisticated two-layer model 
        which are generalizations of model used in the thesis. Those models may have addressed the 
        problems described above, but the model used in the thesis do have some defects. 

        \section{Numerical Calculation of Spectra Based on Two-layer Model}
          After we have understood theory part of the two-layer model, we can then do numerical 
          calculations of spectra 
          based on the theory. Since the theory is the same for all the three MSPs, the calculation 
          algorithms are the same. 

          There are 3 independent parameters to fit altogether in the calculation. 
          The first parameter is fractional gap size $f=h_{2}/R_{lc}$, where $h_{2}$ is the 
          total gap size including both the primary acceleration region and the screening region 
          and $R_{lc}$ is the length of light cylinder. The second parameter is $g_{1}$ so that
          the charge density in the primary accelerating region is $\left(1-g_{1}\right) \rho_{GJ}$, 
          where $\rho_{GJ}$ is the Goldreich-Julian charge density. The third parameter is the ratio 
          between the sizes of the two gaps ($h_{1}/h_{2}$). Note that we only set the charge density in the primary acceleration region as an 
          independent parameter, since the charge density in the two gaps are related to each 
          other. The Fig.s \ref{fig: j0218_twolayer_cur.png} are the spectra of the three MSPs generate 
          from the two-layer model and the result of the fitting parameters are listed in the table 
          \ref{table: twolayer_fit_parameter}. Other than the low energy and high energy gamma-ray bands, 
          the model is consistent with the observation data in terms of gamma-ray part. 

          Generally speaking, the modeled spectra for the three MSPs are acceptable. Just as 
          we have discussed in the data analysis part that global fits are not very consistent 
          with separate fits in low energy gamma-ray band (about $100MeV\sim 1000MeV$) and high energy
          band (above $10GeV$), the modeled spectra also have the same problem. 
          This can have 2 explanations. Firstly, the Fermi telescope is not sensitive in about $100 MeV$.
          As a result, the observation data may not be very reliable at about this energy band. Secondly, the  
          real emission mechanism in the energy band is different from the model predicts. Thus, we can observe 
          inconsistency between the calculations and observations.
 
          \singleFig{j0218_twolayer_cur.png}{0.41}{The modeled spectrum of PSR J0218+4232. 
          \change{python arrow doesn't work properly in log-log scale figure}}
          \singleFig{b1821_twolayer_cur.png}{0.4}{The modeled spectrum of PSR B1821-24. 
          \mayChange{I wanted to combine the three figures together, if I do so, each 
          figure is too small.}}
          \singleFig{j1939_twolayer_cur.png}{0.41}{The modeled spectrum of PSR B1937+21.}
          
          \begin{table}[!ht]
            \centering
            \begin{tabular}{|c|c|c|c|}
              \hline 
              & f & g & $h_1/h_2$ \\ 
              \hline 
              PSR J0218+4232 & 0.330 & 0.92 & 0.915 \\
              \hline 
              PSR B1821-24 & 0.247 & 0.955 & 0.920 \\
              \hline 
              PSR B1937+21 & 0.320 & 0.975 & 0.925 \\
              \hline 
            \end{tabular}
            \mycaption{The results of fitting parameters for the three MSPs. The physical 
              meaning of each parameter is consistent with the two-layer model describe above.
              \change{the table is ugly, but not sure how to make it more beautiful...}}
            \label{table: twolayer_fit_parameter}
          \end{table}
          \vspace{0.5cm}
          
          After obtaining the spectra fit results in gamma-ray band, we can generate broad band spectra 
          as the Fig.s \ref{fig: j0218_twolayer_all.png} shown. 
          The hard X-ray data are from the paper \cite{0004-637X-845-2-159}. By tweaking the 
          independent parameters of the two-layer model, we can make the modeled spectra very 
          close to the observation data in hard X-ray band. Since we lack observation data in 
          the energy band from about $100keV$ to $100MeV$, we cannot tell if the two-layer model 
          describes the right physical scenario in this energy range. However, the prediction made 
          by the simplified two-layer model is relatively precise. In addition, the model is very 
          intuitive, which is also a very important consideration for building a model. Just as 
          the famous words "With four parameters I can fit an elephant, and with five I can make him wiggle his trunk" 
          said by John von Neumann, in principal, we can fit any data by adding independent parameters. 
          Therefore, in order to test if a theory model is good or not, not only we need to consider 
          how precisely the model can predict, but also the physical meaning behind the model. In this 
          sense, the two-layer model is a good start of explaining emission mechanism of 
          pulsars. 
          
        \singleFig{j0218_twolayer_all.png}{0.39}{The broad band and modeled spectrum of PSR J0218+4232.
          The grey shade is the error of the global fit. And the green shade in the left part of the 
          figure represents the error of hard X-ray. The 'Total' legend represents the total flux 
          combining the Synchrotron radiation, inverse Compton radiation and curvature radiation
          altogether.}
        \singleFig{b1821_twolayer_all.png}{0.4}{The broad band and modeled spectrum of PSR B1821-24.
          The meaning of grey shade and the green shade are the same as the Fig.
          \ref{fig: j0218_twolayer_all.png}}
        \singleFig{j1939_twolayer_all.png}{0.39}{The broad band and modeled spectrum of PSR B1937+21.
          The meaning of grey shade and the green shade are the same as the Fig.
          \ref{fig: j0218_twolayer_all.png}}
        
      \section{Pitfalls and Considerations of Doing Numerical Calculation}
        \subsection{Correctness of Computation}
          To make sure the numerical computation be right is the most important. 
          The first consideration is underflow and overflow of floating digits.
          One possible condition is calculating speed of relativistic charged particles with 
          Lorentz factor $\gamma$. By doing some simple test, we find that for 
          $\gamma < 1.5\times 10^7$, the results are precise enough. However, there is significant rounding error
          when $\gamma > 5\times 10^7$, which means that our results will be wrong for highly 
          energetic particles if we directly use the formula $\beta = \sqrt{1 - 1/\gamma^2}$.
          Likely, in the two-layer model, nearly all particles have $\gamma < 1\times 10^7$. 
          Furthermore, there are nearly no situations where double precision floating digits
          cannot handle calculation results of the two-layer model. Thus, as long as we use 
          64-bit floating digits instead of 32-bit floating digits, we are free from overflowing and 
          underflow troubles. 
            
          There are some cases when a whole function can be calculated while some parts of them are not. 
          Take the function $f\left(x\right) = x\times1/x$ for example. When $x$ is too large, it 
          can not be expressed by a computer and multiplication is not associative when doing floating 
          point operation. We encounter some situations like this.
          The formula of curvature radiation spectrum contains modified Bessel function of order $5/3$.
          In order to speed up the program, we use a polynomial to express the Bessel function, as the 
          function \ref{func: polynomial_appro} shown. 
          \begin{equation}
            K_{5/3} \left(x\right) \simeq a \left(\frac{1}{x} + b\right)^{-cx - 1/3} \sqrt{\frac{\pi}{2}} e^{-x - d} \sqrt{x + d} %
            \left[1 + \frac{55}{72\left(x + d\right)} - \frac{10151}{10368}\left(x+d\right)^2\right] 
            \label{func: polynomial_appro}
          \end{equation}
          where $a,b,c,d$ are just positive constants and $c = 0.96 < 1$. As a result, 
          the part $(1/x + b)^{-cx - 1/3}$ in the function \ref{func: polynomial_appro} is infinity
          when $x$ is large though the total function is approximated to $0$. Thus, we have to explicitly 
          assign the result to be $0$ instead of calculating it. Actually, this error is not easy to find 
          since in most cases the result is not infinity. 
          
        \subsection{Speed of Computation}
          We actually have not done any accurate benchmarks for the following discussions and they are 
          dependent of the average time of running the simulation.
          The most obvious solution of to use multicores to do computation. However, most library functions 
          do not support run concurrently and only run on a single core. For example, we need to do many 
          integrations and the speed of integration is critical. We write some simple functions to 
          utilize 4 CPU cores at the same time when doing integration. 
          This gives us a huge performance improvement.

          Furthermore, There are some facts about the basic operations. For instance, add is faster than 
          multiplication which is faster than devision. Multiplications and devisions are not associative
          between floating points. 
          Though the performance differences between different operations for integers can usually be optimized 
          away by modern compilers, the compilers can do nothing for floating points. Thus, we have to do it 
          by ourselves. For example, we have $z^2 - h_2\left(x\right)^2$ in function \ref{eq: twolayer_field}.
          In this formula, we have 2 multiplications and 1 subtraction. After we re-write it to 
          $\left(z-h_2\right)\left(z + h_2\right)$, we have 1 addition, 1 subtraction and 1 multiplication.
          Since addition and subtraction is not slower than multiplication, it has no performance harm 
          for the rewriting. What we need to notice is that the multiplication may not be slower than addition
          and it is dependent on machines. However, division is definitely slower than the other 3 operations. 
          Therefore, in our program, expressions like $1 / 3$ are rewritten to $1*0.3333$ and so on.  
  %stupid

      \chapter{Discussion and Future Work}
        \add{continue from here...}


        

% \begin{thebibliography}{9}


% \end{thebibliography}
\bibliographystyle{plain}
\bibliography{bibfile}
          

\end{document}





